<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pi Builder</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #e6edf3;
    --muted:     #8b949e;
    --accent:    #58a6ff;
    --success:   #3fb950;
    --warn:      #d29922;
    --error:     #f85149;
    --user-bg:   #1c2128;
    --agent-bg:  #0d1117;
    --radius:    8px;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .logo { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; color: var(--accent); }
  .logo span { color: var(--text); font-weight: 400; }

  #status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--error);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  #status-dot.connected { background: var(--success); }
  #status-dot.connecting { background: var(--warn); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  #status-label { font-size: 13px; color: var(--muted); }

  .spacer { flex: 1; }

  .agents-pill {
    font-size: 12px; color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 10px;
    cursor: pointer;
  }
  .agents-pill:hover { border-color: var(--accent); color: var(--accent); }

  .ws-input {
    font-size: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 4px 8px;
    color: var(--text);
    width: 220px;
  }
  .ws-input:focus { outline: none; border-color: var(--accent); }

  /* â”€â”€ Main layout â”€â”€ */
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* â”€â”€ Messages â”€â”€ */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 820px;
    width: 100%;
    align-self: flex-start;
  }
  .msg.user { align-self: flex-end; }

  .msg-header {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-body {
    background: var(--agent-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user .msg-body {
    background: var(--user-bg);
    border-color: #3d444d;
  }

  .agent-tag {
    display: inline-block;
    font-size: 11px;
    padding: 1px 6px;
    border-radius: 4px;
    background: #1c2d40;
    color: var(--accent);
    border: 1px solid #264563;
    font-family: var(--font-mono);
  }

  /* streaming cursor */
  .cursor {
    display: inline-block;
    width: 2px; height: 14px;
    background: var(--accent);
    margin-left: 2px;
    animation: blink 1s step-end infinite;
    vertical-align: text-bottom;
  }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

  /* â”€â”€ Sidebar (agent health + git diff) â”€â”€ */
  #sidebar {
    width: 260px;
    border-left: 1px solid var(--border);
    background: var(--surface);
    overflow-y: auto;
    flex-shrink: 0;
    display: none;
    flex-direction: column;
  }
  #sidebar.open { display: flex; }

  /* git diff panel */
  #diff-panel {
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  #diff-panel .sidebar-title { border-bottom: 1px solid var(--border); }
  #diff-content {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 8px 12px;
    white-space: pre-wrap;
    word-break: break-all;
    color: var(--muted);
    max-height: 240px;
    overflow-y: auto;
  }
  #diff-content.has-diff { color: var(--text); }
  /* full diff syntax coloring */
  #diff-content .dp { color: #58a6ff }   /* @@ hunk header */
  #diff-content .da { color: #3fb950 }   /* + added */
  #diff-content .dr { color: #f85149 }   /* - removed */
  #diff-content .df { color: #d29922; font-weight:600 }  /* diff --git header */

  /* message queue badge */
  #queue-badge {
    display: none;
    position: absolute;
    top: -6px; right: -6px;
    background: var(--warn);
    color: #0d1117;
    font-size: 10px;
    font-weight: 700;
    border-radius: 10px;
    padding: 1px 5px;
    min-width: 16px;
    text-align: center;
  }
  #send-wrap { position: relative; flex-shrink: 0; }

  .sidebar-title {
    padding: 12px 16px 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }

  .agent-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    font-size: 13px;
    font-family: var(--font-mono);
    border-bottom: 1px solid #21262d;
  }
  .agent-row .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .agent-row.ok .dot { background: var(--success); }
  .agent-row.fail .dot { background: var(--error); }

  /* â”€â”€ Input area â”€â”€ */
  footer {
    border-top: 1px solid var(--border);
    padding: 12px 20px;
    background: var(--surface);
    flex-shrink: 0;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  #input-box {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: var(--font-sans);
    font-size: 14px;
    line-height: 1.5;
    padding: 10px 14px;
    resize: none;
    max-height: 200px;
    overflow-y: auto;
    transition: border-color 0.15s;
  }
  #input-box:focus { outline: none; border-color: var(--accent); }
  #input-box::placeholder { color: var(--muted); }

  #send-btn {
    padding: 9px 18px;
    background: var(--accent);
    color: #0d1117;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0;
    transition: opacity 0.15s;
  }
  #send-btn:hover { opacity: 0.85; }
  #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* â”€â”€ Status bar â”€â”€ */
  #status-bar {
    padding: 3px 20px;
    font-size: 11px;
    color: var(--muted);
    background: var(--bg);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    font-family: var(--font-mono);
  }

  /* â”€â”€ Agent selector bar â”€â”€ */
  #agent-bar {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 6px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  #agent-bar.visible { display: flex; }
  #agent-bar::-webkit-scrollbar { display: none; }

  .agent-pill {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    white-space: nowrap;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
    flex-shrink: 0;
  }
  .agent-pill:hover { border-color: var(--accent); color: var(--accent); }
  .agent-pill.active {
    border-color: var(--accent);
    color: var(--accent);
    background: #1c2d40;
  }
  .agent-pill.auto.active {
    border-color: var(--success);
    color: var(--success);
    background: #122318;
  }
  .agent-pill.last-used {
    border-color: #3d444d;
    color: var(--text);
  }

  /* â”€â”€ Scrollbar â”€â”€ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ View tabs â”€â”€ */
  .view-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    padding: 0 20px;
  }
  .view-tab {
    font-size: 12px;
    padding: 7px 14px;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    user-select: none;
    transition: color 0.15s, border-color 0.15s;
  }
  .view-tab:hover { color: var(--text); }
  .view-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* â”€â”€ Threads pane â”€â”€ */
  #threads-pane {
    display: none;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  #threads-pane.visible { display: flex; }

  /* Thread type badges */
  .thread-type {
    display: inline-block;
    font-size: 10px; font-weight: 700; font-family: var(--font-mono);
    padding: 1px 7px; border-radius: 10px; text-transform: uppercase;
    letter-spacing: 0.5px; flex-shrink: 0;
  }
  .thread-type.base  { background:#1a1a2e; color:#79c0ff; }
  .thread-type.p     { background:#0d2a0d; color:#3fb950; }
  .thread-type.c     { background:#1a1f0d; color:#9fc46b; }
  .thread-type.f     { background:#2a1d0d; color:#d29922; }
  .thread-type.b     { background:#1d0d2a; color:#bc8cff; }
  .thread-type.l     { background:#2a0d1a; color:#f85149; }
  .thread-type.z     { background:#1a0a0a; color:#ff6e6e; }

  .thread-type-legend {
    display: flex; flex-wrap: wrap; gap: 6px;
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    background: var(--surface); flex-shrink: 0;
  }
  .thread-legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--muted); }

  /* Preset buttons */
  .thread-preset-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    background: var(--surface); flex-shrink: 0;
  }
  .thread-preset-btn {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 7px 8px;
    font-size: 11px; color: var(--text); cursor: pointer; text-align: left;
  }
  .thread-preset-btn:hover { border-color: var(--accent); color: var(--accent); }
  .thread-preset-btn strong { display: block; font-size: 12px; margin-bottom: 2px; color: var(--accent); }
  .thread-preset-btn span { color: var(--muted); }

  /* Custom builder */
  .thread-builder {
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    background: var(--surface); display: flex; gap: 6px; align-items: center;
    flex-shrink: 0; flex-wrap: wrap;
  }
  .thread-builder select, .thread-builder input {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 12px;
    padding: 4px 8px; font-family: var(--font-mono);
  }
  .thread-builder select { min-width: 80px; }
  .thread-builder input  { flex: 1; min-width: 120px; }

  /* Thread run cards */
  .thread-list { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
  .thread-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }
  .thread-card.running { border-color: var(--accent); }
  .thread-card.idle    { border-color: var(--success); }
  .thread-card.killed  { border-color: var(--muted); opacity: 0.6; }

  .thread-card-header {
    display: flex; align-items: center; gap: 8px; padding: 8px 12px;
    cursor: pointer; background: var(--bg);
  }
  .thread-card-header:hover { background: #161b22; }
  .thread-card-id { font-family: var(--font-mono); font-size: 11px; color: var(--muted); }
  .thread-card-status { font-size: 11px; margin-left: auto; }
  .thread-card-status.running { color: var(--accent); }
  .thread-card-status.idle    { color: var(--success); }
  .thread-card-status.killed  { color: var(--muted); }

  .thread-cmd {
    padding: 6px 12px; font-family: var(--font-mono); font-size: 11px;
    color: var(--muted); background: var(--surface);
    border-top: 1px solid var(--border);
    white-space: pre-wrap; word-break: break-all;
  }

  .thread-events {
    max-height: 200px; overflow-y: auto;
    padding: 8px 12px; display: flex; flex-direction: column; gap: 3px;
    border-top: 1px solid var(--border);
    font-family: var(--font-mono); font-size: 12px;
  }
  .thread-events::-webkit-scrollbar { width: 4px; }
  .thread-events::-webkit-scrollbar-thumb { background: var(--border); }

  .thread-ev { display: flex; gap: 6px; line-height: 1.4; }
  .thread-ev-type { flex-shrink: 0; width: 120px; font-size: 10px; font-weight: 600; color: var(--muted); }
  .thread-ev-type.message_update { color: var(--accent); }
  .thread-ev-type.tool_execution_start { color: var(--warn); }
  .thread-ev-type.turn_end { color: var(--success); }
  .thread-ev-body { flex: 1; color: var(--text); word-break: break-all; white-space: pre-wrap; }

  .thread-actions { display: flex; gap: 6px; padding: 6px 12px; border-top: 1px solid var(--border); }
  .thread-actions button {
    background: none; border: 1px solid var(--border); border-radius: 5px;
    color: var(--muted); font-size: 11px; padding: 3px 8px; cursor: pointer;
  }
  .thread-actions button:hover { border-color: var(--accent); color: var(--accent); }
  .thread-actions button.danger:hover { border-color: var(--error); color: var(--error); }

  /* Thread prompt builder */
  #thread-steps-area { font-size: 12px; font-family: var(--font-mono); }

  /* â”€â”€ RPC Sessions pane â”€â”€ */
  #rpc-pane, #teams-pane {
    display: none;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  #rpc-pane.visible, #teams-pane.visible { display: flex; }

  .pane-toolbar {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .pane-toolbar input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 12px;
    padding: 4px 8px;
    flex: 1;
    min-width: 0;
    font-family: var(--font-mono);
  }
  .pane-toolbar input:focus { outline: none; border-color: var(--accent); }
  .pane-toolbar button {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-size: 12px;
    padding: 4px 10px;
    cursor: pointer;
    white-space: nowrap;
  }
  .pane-toolbar button:hover { border-color: var(--accent); color: var(--accent); }
  .pane-toolbar button.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #000;
    font-weight: 600;
  }
  .pane-toolbar button.primary:hover { background: #79c0ff; }
  .pane-toolbar select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 12px;
    padding: 4px 8px;
  }

  .pane-body {
    flex: 1;
    display: flex;
    overflow: hidden;
    gap: 0;
  }

  /* Left: session/team list */
  .pane-list {
    width: 220px;
    flex-shrink: 0;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    background: var(--surface);
    display: flex;
    flex-direction: column;
  }
  .pane-list-header {
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .pane-list-item {
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .pane-list-item:hover { background: var(--bg); }
  .pane-list-item.active { background: #1c2128; color: var(--accent); }
  .pane-list-item .item-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
    background: var(--success);
  }
  .pane-list-item .item-dot.idle { background: var(--warn); }
  .pane-list-item .item-dot.dead { background: var(--muted); }
  .pane-list-meta { font-size: 11px; color: var(--muted); margin-left: auto; }

  /* Right: event stream / team detail */
  .pane-detail {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .pane-detail-header {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  .pane-detail-header .session-id {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--accent);
  }
  .event-stream {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    font-size: 13px;
    font-family: var(--font-mono);
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .event-stream::-webkit-scrollbar { width: 6px; }
  .event-stream::-webkit-scrollbar-track { background: transparent; }
  .event-stream::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .ev { display: flex; gap: 8px; align-items: flex-start; line-height: 1.5; }
  .ev-type {
    flex-shrink: 0; width: 140px;
    font-size: 11px; font-weight: 600;
    padding: 1px 6px; border-radius: 4px;
    text-align: center;
  }
  .ev-type.agent_start   { background:#0d2a0d; color:#3fb950; }
  .ev-type.agent_end     { background:#0d2a0d; color:#3fb950; }
  .ev-type.message_update{ background:#0d1f3c; color:#58a6ff; }
  .ev-type.tool_start    { background:#2a1d0d; color:#d29922; }
  .ev-type.tool_end      { background:#2a1d0d; color:#d29922; }
  .ev-type.turn_end      { background:#1a0d2a; color:#bc8cff; }
  .ev-type.error         { background:#2a0d0d; color:#f85149; }
  .ev-body { flex: 1; color: var(--text); word-break: break-all; white-space: pre-wrap; }

  /* Prompt bar at bottom of detail */
  .pane-prompt {
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    gap: 8px;
    align-items: flex-end;
    flex-shrink: 0;
  }
  .pane-prompt textarea {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 13px;
    font-family: var(--font-sans);
    padding: 8px 10px;
    resize: none;
    min-height: 38px;
    max-height: 120px;
  }
  .pane-prompt textarea:focus { outline: none; border-color: var(--accent); }

  /* Teams: task list inside detail */
  .task-list { flex: 1; overflow-y: auto; padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
  .task-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 12px;
    font-size: 13px;
  }
  .task-card.completed { border-color: #238636; opacity: 0.7; }
  .task-card.in_progress { border-color: var(--accent); }
  .task-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .task-status {
    font-size: 11px; font-weight: 600; padding: 1px 7px; border-radius: 10px;
  }
  .task-status.pending    { background: #21262d; color: var(--muted); }
  .task-status.in_progress{ background: #0d1f3c; color: var(--accent); }
  .task-status.completed  { background: #0d2a0d; color: var(--success); }
  .task-status.deleted    { background: #2a0d0d; color: var(--error); }
  .task-owner { font-size: 11px; color: var(--muted); margin-left: auto; }
  .task-subject { font-weight: 600; }
  .task-desc { font-size: 12px; color: var(--muted); margin-top: 4px; }

  .member-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 6px; }
  .member-row {
    display: flex; align-items: center; gap: 10px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px 12px; font-size: 13px;
  }
  .member-type { font-size: 11px; color: var(--muted); margin-left: auto; font-family: var(--font-mono); }

  .progress-bar-wrap {
    margin: 0 16px 12px; height: 6px;
    background: var(--surface); border-radius: 3px; overflow: hidden;
  }
  .progress-bar { height: 100%; background: var(--accent); transition: width 0.4s; }
  .progress-label { text-align: right; font-size: 11px; color: var(--muted); padding: 0 16px 8px; }

  /* Team preset buttons */
  .preset-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
    padding: 12px 16px;
  }
  .preset-btn {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 6px; padding: 8px 6px;
    font-size: 11px; color: var(--text); cursor: pointer; text-align: center;
  }
  .preset-btn:hover { border-color: var(--accent); color: var(--accent); }
  .preset-btn strong { display: block; font-size: 12px; margin-bottom: 2px; }

  /* â”€â”€ Terminal pane â”€â”€ */
  #terminal-pane {
    display: none;
    flex: 1;
    flex-direction: column;
    overflow: hidden;
    background: #0d0d0d;
  }
  #terminal-pane.visible { display: flex; }

  #terminal-agent-tabs {
    display: flex;
    gap: 0;
    background: #111;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  #terminal-agent-tabs::-webkit-scrollbar { display: none; }

  .term-tab {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 6px 14px;
    cursor: pointer;
    color: var(--muted);
    border-right: 1px solid var(--border);
    white-space: nowrap;
    transition: background 0.15s, color 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .term-tab:hover { background: #1a1a1a; color: var(--text); }
  .term-tab.active { background: #0d0d0d; color: var(--accent); }
  .term-tab .term-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--success);
    flex-shrink: 0;
  }
  .term-tab .term-dot.dead { background: var(--error); }
  .term-tab .term-close {
    opacity: 0.5;
    font-size: 10px;
    margin-left: 4px;
    line-height: 1;
  }
  .term-tab .term-close:hover { opacity: 1; color: var(--error); }

  .term-add-btn {
    font-size: 18px;
    padding: 0 12px;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .term-add-btn:hover { color: var(--accent); }

  #terminal-containers {
    flex: 1;
    position: relative;
    overflow: hidden;
  }
  .term-container {
    position: absolute;
    inset: 0;
    padding: 8px;
    display: none;
  }
  .term-container.active { display: block; }

  #terminal-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    background: #111;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
  }
  #terminal-toolbar input {
    flex: 1;
    background: #0d0d0d;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px 8px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 11px;
  }
  #terminal-toolbar input:focus { outline: none; border-color: var(--accent); }
  #terminal-toolbar button {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px 10px;
    color: var(--text);
    font-size: 11px;
    cursor: pointer;
  }
  #terminal-toolbar button:hover { border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<header>
  <div class="logo">pi<span>-builder</span></div>
  <div id="status-dot" class="connecting"></div>
  <div id="status-label">connectingâ€¦</div>
  <div class="spacer"></div>
  <input class="ws-input" id="ws-url" placeholder="ws://â€¦">
  <button class="agents-pill" onclick="toggleSidebar()">agents</button>
</header>

<div id="agent-bar"></div>

<div class="view-tabs">
  <div class="view-tab active" id="tab-chat"     onclick="switchView('chat')">Chat</div>
  <div class="view-tab"        id="tab-threads"  onclick="switchView('threads')">Threads</div>
  <div class="view-tab"        id="tab-rpc"      onclick="switchView('rpc')">Sessions</div>
  <div class="view-tab"        id="tab-teams"    onclick="switchView('teams')">Teams</div>
  <div class="view-tab"        id="tab-terminal" onclick="switchView('terminal')">Terminal</div>
</div>

<main>
  <div id="messages">
    <div class="msg" id="welcome">
      <div class="msg-body" style="color:var(--muted);border-color:#21262d;">
        Pi Builder routes your prompts to any installed CLI coding agent.<br>
        Type a message below to start. Make sure <code style="font-family:var(--font-mono);color:var(--accent)">pi-builder start</code> is running.
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div class="sidebar-title">Agents</div>
    <div id="agent-list"><div style="padding:12px 16px;font-size:12px;color:var(--muted)">Loadingâ€¦</div></div>
    <div id="diff-panel">
      <div class="sidebar-title" style="display:flex;align-items:center;justify-content:space-between">
        <span>Git Diff</span>
        <div style="display:flex;gap:4px">
          <button id="diff-stat-btn" onclick="diffSetMode('stat')"
            style="font-size:10px;padding:1px 6px;border-radius:4px;border:1px solid var(--accent);background:var(--accent);color:#000;cursor:pointer">stat</button>
          <button id="diff-full-btn" onclick="diffSetMode('full')"
            style="font-size:10px;padding:1px 6px;border-radius:4px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer">full</button>
        </div>
      </div>
      <div id="diff-content">no changes yet</div>
    </div>
  </div>
</main>

<!-- â”€â”€ Threads pane (thread-based engineering via pi-subagents) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="threads-pane">
  <!-- Legend -->
  <div class="thread-type-legend">
    <div class="thread-legend-item"><span class="thread-type base">base</span> single agent</div>
    <div class="thread-legend-item"><span class="thread-type p">P</span> parallel</div>
    <div class="thread-legend-item"><span class="thread-type c">C</span> chain</div>
    <div class="thread-legend-item"><span class="thread-type f">F</span> fusion</div>
    <div class="thread-legend-item"><span class="thread-type b">B</span> delegate (/run)</div>
    <div class="thread-legend-item"><span class="thread-type l">L</span> long-duration</div>
  </div>

  <!-- Presets -->
  <div class="thread-preset-grid">
    <button class="thread-preset-btn" onclick="threadPreset('codeReview')">
      <strong>Code Review</strong><span>scout â†’ reviewer (C)</span>
    </button>
    <button class="thread-preset-btn" onclick="threadPreset('parallelReview')">
      <strong>Parallel Review</strong><span>security + perf + arch (P)</span>
    </button>
    <button class="thread-preset-btn" onclick="threadPreset('planAndBuild')">
      <strong>Plan &amp; Build</strong><span>scout â†’ planner â†’ worker (C)</span>
    </button>
    <button class="thread-preset-btn" onclick="threadPreset('debugFusion')">
      <strong>Debug Fusion</strong><span>3Ã— worker â†’ pick best (F)</span>
    </button>
    <button class="thread-preset-btn" onclick="threadPreset('parallelResearch')">
      <strong>Research</strong><span>scout + researcher (P)</span>
    </button>
    <button class="thread-preset-btn" onclick="threadPreset('custom')">
      <strong>Custom</strong><span>use builder below</span>
    </button>
  </div>

  <!-- Custom builder -->
  <div class="thread-builder">
    <select id="thread-type-select">
      <option value="base">Base â€” single prompt</option>
      <option value="b">B â€” /run agent task</option>
      <option value="c">C â€” /chain (sequential)</option>
      <option value="p">P â€” /parallel (parallel)</option>
      <option value="f">F â€” Fusion (same task Ã— N)</option>
      <option value="l">L â€” Long duration</option>
    </select>
    <input id="thread-task-input" placeholder="task / topic / descriptionâ€¦">
    <input id="thread-agent-input" placeholder="agent (scout/planner/workerâ€¦)" style="max-width:160px">
    <input id="thread-cwd-input"   placeholder="cwd (optional)"              style="max-width:140px">
    <button class="primary" onclick="threadLaunch()" style="background:var(--accent);border-color:var(--accent);color:#000;font-weight:600;border:none;border-radius:6px;padding:4px 14px;cursor:pointer">â–¶ Launch</button>
    <button onclick="threadRefresh()" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);padding:4px 10px;cursor:pointer;font-size:12px">â†º</button>
  </div>

  <!-- Thread list -->
  <div class="thread-list" id="thread-list" style="flex:1">
    <div style="color:var(--muted);font-size:12px;padding:8px">
      No threads yet â€” use a preset or the builder above.
      Requires <code style="color:var(--accent)">pi install npm:pi-subagents</code>.
    </div>
  </div>

  <!-- Async background jobs (pi-subagents async mode) -->
  <div id="async-jobs-section" style="border-top:1px solid var(--border);flex-shrink:0;background:var(--surface)">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 14px;cursor:pointer"
         onclick="document.getElementById('async-jobs-body').style.display=document.getElementById('async-jobs-body').style.display==='none'?'block':'none'">
      <span style="font-size:11px;color:var(--muted);font-weight:600;letter-spacing:.5px">ASYNC BACKGROUND JOBS</span>
      <button onclick="event.stopPropagation();send({type:'thread_async_list',id:'al-'+Date.now()})"
        style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;padding:0">â†º</button>
    </div>
    <div id="async-jobs-body" style="display:none;max-height:140px;overflow-y:auto">
      <div id="async-jobs-list" style="padding:4px 14px 8px;font-size:11px;font-family:var(--font-mono);color:var(--muted)">
        No background jobs found.
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ RPC Sessions pane â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="rpc-pane">
  <div class="pane-toolbar">
    <input id="rpc-cwd-input" placeholder="cwd (default: gateway cwd)" style="max-width:280px">
    <button class="primary" onclick="rpcNewSession()">ï¼‹ New Session</button>
    <button onclick="rpcRefreshList()">â†º Refresh</button>
    <span id="rpc-session-count" style="font-size:12px;color:var(--muted);margin-left:auto"></span>
  </div>
  <div class="pane-body">
    <div class="pane-list">
      <div class="pane-list-header">Sessions</div>
      <div id="rpc-session-list"><div style="padding:14px;font-size:12px;color:var(--muted)">No sessions yet</div></div>
    </div>
    <div class="pane-detail">
      <div class="pane-detail-header">
        <span id="rpc-detail-label" style="color:var(--muted)">Select a session</span>
        <span id="rpc-detail-id" class="session-id"></span>
        <span style="flex:1"></span>
        <button id="rpc-abort-btn" onclick="rpcAbort()" style="display:none">â¹ Abort</button>
        <button id="rpc-kill-btn"  onclick="rpcKill()"  style="display:none;color:var(--error)">âœ• Kill</button>
      </div>
      <div class="event-stream" id="rpc-event-stream">
        <div class="ev"><span class="ev-type message_update">info</span><span class="ev-body" style="color:var(--muted)">Create or select a session to start a pi conversation.</span></div>
      </div>
      <div class="pane-prompt">
        <textarea id="rpc-prompt-input" placeholder="Type a messageâ€¦ (Enter to send, Shift+Enter for newline)" rows="1" disabled></textarea>
        <button class="primary" id="rpc-send-btn" disabled onclick="rpcSend()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Agent Teams pane â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="teams-pane">
  <div class="pane-toolbar">
    <select id="teams-preset-select">
      <option value="">â€” Preset â€”</option>
      <option value="review">review (security+perf+arch)</option>
      <option value="debug">debug (3 investigators)</option>
      <option value="feature">feature (lead+2 implementers)</option>
      <option value="fullstack">fullstack (lead+frontend+backend+tests)</option>
      <option value="research">research (3 researchers)</option>
      <option value="security">security (OWASP+auth+deps+secrets)</option>
      <option value="migration">migration (lead+2 impl+verifier)</option>
    </select>
    <input id="teams-name-input" placeholder="team-name (optional)" style="max-width:180px">
    <button class="primary" onclick="teamsCreate()">ï¼‹ Create Team</button>
    <button onclick="teamsRefresh()">â†º Refresh</button>
  </div>
  <div class="pane-body">
    <div class="pane-list">
      <div class="pane-list-header">Teams</div>
      <div id="teams-list"><div style="padding:14px;font-size:12px;color:var(--muted)">No teams yet</div></div>
    </div>
    <div class="pane-detail" id="teams-detail">
      <div class="pane-detail-header">
        <span id="teams-detail-name" style="color:var(--muted)">Select a team</span>
        <span style="flex:1"></span>
        <button id="teams-spawn-btn" onclick="teamsSpawn()" style="display:none">â–¶ Spawn claude</button>
        <button id="teams-watch-btn" onclick="teamsToggleWatch()" style="display:none">ğŸ‘ Watch</button>
      </div>
      <!-- Members -->
      <div id="teams-members" class="member-list"></div>
      <!-- Progress bar -->
      <div class="progress-bar-wrap"><div class="progress-bar" id="teams-progress-bar" style="width:0%"></div></div>
      <div class="progress-label" id="teams-progress-label">0 / 0 tasks</div>
      <!-- Tasks -->
      <div id="teams-tasks" class="task-list"><div style="color:var(--muted);font-size:12px">No tasks</div></div>
      <!-- Claude stdout stream -->
      <div id="teams-output-wrap" style="display:none;flex-direction:column;border-top:1px solid var(--border);flex-shrink:0">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 12px;background:var(--bg);font-size:11px;color:var(--muted)">
          <span>claude output</span>
          <button onclick="teamsClearOutput()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px">clear</button>
        </div>
        <pre id="teams-output" style="
          margin:0;padding:8px 12px;
          font-family:var(--font-mono);font-size:11px;
          color:var(--text);background:var(--surface);
          max-height:180px;overflow-y:auto;
          white-space:pre-wrap;word-break:break-all;
          border-bottom:1px solid var(--border);
        "></pre>
      </div>
      <!-- Send message to agent -->
      <div class="pane-prompt" id="teams-msg-bar" style="display:none">
        <select id="teams-msg-to" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;padding:4px 8px"></select>
        <textarea id="teams-msg-input" placeholder="Message to teammateâ€¦" rows="1"></textarea>
        <button class="primary" onclick="teamsSendMsg()">Send</button>
        <button onclick="teamsBroadcast()">ğŸ“¢ Broadcast</button>
      </div>
    </div>
  </div>
</div>

<!-- Terminal pane (ghostty-web) -->
<div id="terminal-pane">
  <div id="terminal-agent-tabs">
    <div class="term-add-btn" onclick="spawnTerminal()" title="New terminal">+</div>
  </div>
  <div id="terminal-containers"></div>
  <div id="terminal-toolbar">
    <span>cmd:</span>
    <input id="term-cmd-input" placeholder="pi  /  claude  /  aider  /  shell" value="pi">
    <button onclick="spawnTerminal()">Spawn</button>
    <span id="term-status" style="margin-left:auto">no session</span>
  </div>
</div>

<footer>
  <textarea id="input-box" rows="1" placeholder="Ask anything about your codebaseâ€¦" disabled></textarea>
  <div id="send-wrap">
    <button id="send-btn" disabled>Send</button>
    <span id="queue-badge">0</span>
  </div>
</footer>

<div id="status-bar">not connected</div>

<script>
// Injected by Electron preload (undefined when running in browser)
/** @type {{ isDesktop: boolean, gatewayInfo: () => Promise<{url:string|null}>, versions: object } | undefined} */
const piBuilderDesktop = window.piBuilderDesktop

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null
let streaming = null   // { el: Element, cursor: Element } | null
let msgSeq = 0
let sidebarOpen = false
let pinnedAgent = null  // null = Auto, string = agent id
let queueCount = 0

// â”€â”€ Auto-detect WS URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// When served via HTTP (e.g. http://localhost:18900/), derive WS URL from page host.
// When opened as a local file, fall back to ws://127.0.0.1:18900.
;(async function setDefaultWsUrl() {
  const input = document.getElementById('ws-url')
  if (input.value) return

  // Desktop app: ask the preload for the gateway URL
  if (window.piBuilderDesktop?.isDesktop) {
    try {
      const info = await window.piBuilderDesktop.gatewayInfo()
      if (info?.url) { input.value = info.url; return }
    } catch { /* fallthrough */ }
  }

  // Served over HTTP: derive from page host
  if (location.protocol === 'http:' || location.protocol === 'https:') {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws'
    input.value = `${proto}://${location.host}`
    return
  }

  // Local file fallback
  input.value = 'ws://127.0.0.1:18900'
})()

// â”€â”€ WebSocket connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connect() {
  const url = document.getElementById('ws-url').value.trim()
  setStatus('connecting', 'connectingâ€¦')

  ws = new WebSocket(url)

  ws.onopen = () => {
    setStatus('connected', 'connected')
    setBar(`connected to ${url}`)
    enableInput(true)
    requestHealth()
    // Restore session history on (re)connect
    send({ type: 'history', id: 'restore' })
  }

  ws.onclose = () => {
    setStatus('', 'disconnected')
    setBar('disconnected â€” reconnecting in 3sâ€¦')
    enableInput(false)
    setTimeout(connect, 3000)
  }

  ws.onerror = () => {
    setStatus('', 'error')
    setBar('connection error')
  }

  ws.onmessage = (ev) => {
    try { handleFrame(JSON.parse(ev.data)) }
    catch (e) { console.warn('bad frame', e) }
  }
}

function send(frame) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(frame))
  }
}

// â”€â”€ Frame handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFrame(f) {
  switch (f.type) {
    case 'hello':
      setBar(`session: ${f.sessionId}`)
      break

    case 'user_message':
      // already rendered optimistically â€” skip
      break

    case 'agent_start':
      setBar(`â–¶ ${f.agent}: ${f.task || 'â€¦'}`)
      break

    case 'chunk':
      appendChunk(f.agent, f.text)
      break

    case 'turn_complete':
      finishStream(f.message)
      setBar(`âœ“ ${f.message?.agentUsed || ''} â€” ${f.message?.durationMs || 0}ms`)
      if (f.message?.agentUsed) flashLastUsed(f.message.agentUsed)
      // Queue count decrements as turns complete
      if (queueCount > 0) { queueCount--; updateQueueBadge() }
      break

    case 'agent_end':
      break

    case 'error':
      finishStream(null)
      appendError(f.message)
      setBar(`âŒ ${f.message}`)
      enableInput(true)
      break

    case 'health':
      renderHealth(f.agents)
      break

    case 'agents':
      renderAgentList(f.list)
      break

    case 'history':
      renderHistory(f.messages)
      break

    case 'diff':
      diffStatText = f.diff
      if (diffMode === 'stat') renderDiff(f.diff, false)
      break
    case 'diff_full':
      diffPatchText = f.patch
      if (!diffStatText) diffStatText = f.stat
      if (diffMode === 'full') renderDiff(f.patch, true)
      break

    case 'queued':
      queueCount = f.queueLength || 0
      updateQueueBadge()
      break

    case 'ok':
      break

    // Thread frames
    case 'thread_launched':
    case 'thread_event':
    case 'thread_idle':
    case 'thread_killed':
    case 'thread_list':
    case 'thread_preset_preview':
      handleThreadFrame(f)
      break

    // RPC session frames
    case 'rpc_created':
    case 'rpc_event':
    case 'rpc_idle':
    case 'rpc_killed':
    case 'rpc_sessions':
      handleRpcFrame(f)
      break

    // Agent Teams frames
    case 'teams_list':
    case 'teams_created':
    case 'teams_task':
    case 'teams_tasks':
    case 'teams_output':
    case 'teams_exit':
    case 'teams_message':
      handleTeamsFrame(f)
      break
  }
}

// â”€â”€ Streaming â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendChunk(agent, text) {
  if (!streaming) {
    const id = ++msgSeq
    const html = `
      <div class="msg" id="msg-${id}">
        <div class="msg-header">
          <span class="agent-tag">${escHtml(agent)}</span>
        </div>
        <div class="msg-body" id="body-${id}"></div>
      </div>`
    document.getElementById('messages').insertAdjacentHTML('beforeend', html)
    const cursor = document.createElement('span')
    cursor.className = 'cursor'
    const body = document.getElementById(`body-${id}`)
    body.appendChild(cursor)
    streaming = { body, cursor }
  }
  streaming.cursor.insertAdjacentText('beforebegin', text)
  scrollBottom()
}

function finishStream(message) {
  if (streaming) {
    streaming.cursor.remove()
    streaming = null
  }
  enableInput(true)
}

// â”€â”€ Message rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUserMsg(text) {
  const id = ++msgSeq
  const ts = new Date().toLocaleTimeString()
  document.getElementById('messages').insertAdjacentHTML('beforeend', `
    <div class="msg user" id="msg-${id}">
      <div class="msg-header" style="justify-content:flex-end">
        <span style="color:var(--muted)">${ts}</span> you
      </div>
      <div class="msg-body">${escHtml(text)}</div>
    </div>`)
  scrollBottom()
}

function appendError(msg) {
  document.getElementById('messages').insertAdjacentHTML('beforeend', `
    <div class="msg">
      <div class="msg-body" style="color:var(--error);border-color:#531e1e">${escHtml(msg)}</div>
    </div>`)
  scrollBottom()
}

function renderHistory(messages) {
  if (!messages || messages.length === 0) return
  const container = document.getElementById('messages')
  // Clear existing messages + welcome to avoid duplicates on reconnect
  container.innerHTML = ''

  for (const m of messages) {
    const id = ++msgSeq
    const role = m.role === 'user' ? 'user' : ''
    const header = m.role === 'user'
      ? `<div class="msg-header" style="justify-content:flex-end">you</div>`
      : `<div class="msg-header"><span class="agent-tag">${escHtml(m.agentUsed || 'assistant')}</span></div>`
    container.insertAdjacentHTML('beforeend', `
      <div class="msg ${role}" id="msg-${id}">
        ${header}
        <div class="msg-body">${escHtml(m.content)}</div>
      </div>`)
  }
  scrollBottom()
}

// â”€â”€ Health / agents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requestHealth() {
  send({ type: 'agents', id: 'init-agents' })
}

function renderAgentList(list) {
  // Sidebar
  const el = document.getElementById('agent-list')
  if (!list || list.length === 0) {
    el.innerHTML = '<div style="padding:12px 16px;font-size:12px;color:var(--muted)">No agents found</div>'
    return
  }
  el.innerHTML = list.map(a =>
    `<div class="agent-row ok">
      <div class="dot"></div>
      <span>${escHtml(a.id)}</span>
    </div>`
  ).join('')

  // Agent selector bar
  const bar = document.getElementById('agent-bar')
  bar.innerHTML = ''

  const autoPill = document.createElement('button')
  autoPill.className = 'agent-pill auto' + (pinnedAgent === null ? ' active' : '')
  autoPill.textContent = 'Auto'
  autoPill.title = 'Route to best available agent'
  autoPill.addEventListener('click', () => setPinnedAgent(null))
  bar.appendChild(autoPill)

  for (const a of list) {
    const pill = document.createElement('button')
    pill.className = 'agent-pill' + (pinnedAgent === a.id ? ' active' : '')
    pill.textContent = a.id
    pill.title = a.capabilities?.join(', ') || a.id
    pill.dataset.agentId = a.id
    pill.addEventListener('click', () => setPinnedAgent(a.id))
    bar.appendChild(pill)
  }

  bar.classList.add('visible')
}

function setPinnedAgent(agentId) {
  pinnedAgent = agentId
  // Update pill active states
  const bar = document.getElementById('agent-bar')
  bar.querySelectorAll('.agent-pill').forEach(p => {
    p.classList.remove('active', 'last-used')
    const isAuto = p.classList.contains('auto')
    const matches = isAuto ? agentId === null : p.dataset.agentId === agentId
    if (matches) p.classList.add('active')
  })
  // Update placeholder
  const input = document.getElementById('input-box')
  input.placeholder = agentId
    ? `Ask ${agentId}â€¦`
    : 'Ask anything about your codebaseâ€¦'
}

// â”€â”€ Git diff display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let diffMode = 'stat'   // 'stat' | 'full'
let diffStatText = null
let diffPatchText = null

window.diffSetMode = function(mode) {
  diffMode = mode
  const sb = document.getElementById('diff-stat-btn')
  const fb = document.getElementById('diff-full-btn')
  if (sb) {
    sb.style.background = mode === 'stat' ? 'var(--accent)' : 'none'
    sb.style.color      = mode === 'stat' ? '#000' : 'var(--muted)'
    sb.style.borderColor= mode === 'stat' ? 'var(--accent)' : 'var(--border)'
  }
  if (fb) {
    fb.style.background = mode === 'full' ? 'var(--accent)' : 'none'
    fb.style.color      = mode === 'full' ? '#000' : 'var(--muted)'
    fb.style.borderColor= mode === 'full' ? 'var(--accent)' : 'var(--border)'
  }
  if (mode === 'full' && !diffPatchText) {
    // Request full patch
    send({ type: 'diff_full', id: 'df-req' })
  } else {
    renderDiff(mode === 'full' ? diffPatchText : diffStatText, mode === 'full')
  }
}

function renderDiff(text, isFullPatch = false) {
  const el = document.getElementById('diff-content')
  if (!text) {
    el.innerHTML = '<span style="color:var(--muted)">no changes</span>'
    el.classList.remove('has-diff')
    return
  }
  el.classList.add('has-diff')

  if (!isFullPatch) {
    el.textContent = text
  } else {
    // Syntax-color the unified diff
    const html = text.split('\n').map(line => {
      const esc = line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      if (line.startsWith('diff --git')) return `<span class="df">${esc}</span>`
      if (line.startsWith('@@'))         return `<span class="dp">${esc}</span>`
      if (line.startsWith('+'))          return `<span class="da">${esc}</span>`
      if (line.startsWith('-'))          return `<span class="dr">${esc}</span>`
      return esc
    }).join('\n')
    el.innerHTML = html
  }

  // Auto-open sidebar if diff arrives and sidebar is closed
  if (!sidebarOpen) {
    sidebarOpen = true
    document.getElementById('sidebar').classList.add('open')
  }
}

function updateQueueBadge() {
  const badge = document.getElementById('queue-badge')
  if (queueCount > 0) {
    badge.textContent = queueCount
    badge.style.display = 'block'
  } else {
    badge.style.display = 'none'
  }
}

function flashLastUsed(agentId) {
  if (pinnedAgent !== null) return  // pinned â€” don't flash
  const bar = document.getElementById('agent-bar')
  bar.querySelectorAll('.agent-pill').forEach(p => p.classList.remove('last-used'))
  const pill = bar.querySelector(`[data-agent-id="${CSS.escape(agentId)}"]`)
  if (pill) pill.classList.add('last-used')
}

function renderHealth(agents) {
  if (!agents) return

  // Sidebar: show all agents with health dot
  const el = document.getElementById('agent-list')
  el.innerHTML = Object.entries(agents).map(([id, ok]) =>
    `<div class="agent-row ${ok ? 'ok' : 'fail'}">
      <div class="dot"></div>
      <span>${escHtml(id)}</span>
    </div>`
  ).join('')

  // Pill bar: dim pills for unhealthy agents; don't touch active/last-used state
  const bar = document.getElementById('agent-bar')
  if (!bar.classList.contains('visible')) return
  bar.querySelectorAll('.agent-pill[data-agent-id]').forEach(p => {
    const ok = agents[p.dataset.agentId]
    p.style.opacity = ok === false ? '0.35' : ''
    p.title = ok === false ? `${p.dataset.agentId} â€” not available` : (p.dataset.agentId ?? '')
  })
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage() {
  const input = document.getElementById('input-box')
  const text = input.value.trim()
  if (!text) return

  addUserMsg(text)
  input.value = ''
  input.style.height = 'auto'
  enableInput(false)

  // If an agent is pinned, prepend @agentid (middleware handles routing)
  const message = pinnedAgent ? `@${pinnedAgent} ${text}` : text
  send({ type: 'send', id: `msg-${Date.now()}`, message })
}

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  sidebarOpen = !sidebarOpen
  document.getElementById('sidebar').classList.toggle('open', sidebarOpen)
  if (sidebarOpen) send({ type: 'health', id: 'sidebar-health' })
}

function setStatus(cls, label) {
  const dot = document.getElementById('status-dot')
  dot.className = cls
  document.getElementById('status-label').textContent = label
}

function setBar(text) {
  document.getElementById('status-bar').textContent = text
}

function enableInput(on) {
  document.getElementById('input-box').disabled = !on
  document.getElementById('send-btn').disabled = !on
  if (on) document.getElementById('input-box').focus()
}

function scrollBottom() {
  const el = document.getElementById('messages')
  el.scrollTop = el.scrollHeight
}

function escHtml(str) {
  return String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
}

// â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('send-btn').addEventListener('click', sendMessage)

document.getElementById('input-box').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault()
    sendMessage()
  }
})

// Auto-resize textarea
document.getElementById('input-box').addEventListener('input', function () {
  this.style.height = 'auto'
  this.style.height = Math.min(this.scrollHeight, 200) + 'px'
})

// Reconnect on URL change
document.getElementById('ws-url').addEventListener('change', () => {
  if (ws) ws.close()
})

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connect()
</script>

<!-- â”€â”€ Threads tab (thread-based engineering via pi-subagents) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const threads = new Map()  // threadId â†’ ThreadRun
let activePreset = null

// â”€â”€ switchView patch will add threads handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (the canonical switchView is defined in the next script block; we register
//  a post-hook via the existing pattern: store previous, wrap, restore)

// â”€â”€ Preset launcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRESET_ARGS = {
  codeReview:       'src/',
  parallelReview:   'src/',
  planAndBuild:     'add the feature',
  debugFusion:      'describe the bug here',
  parallelResearch: 'your research question',
}

window.threadPreset = function(name) {
  if (name === 'custom') {
    document.getElementById('thread-task-input').focus()
    return
  }
  activePreset = name
  const defaultArg = PRESET_ARGS[name] ?? ''
  const task = prompt(`Task / target for "${name}" preset:`, defaultArg)
  if (!task) return
  send({ type: 'thread_preset', id: `tp-${Date.now()}`, preset: name, arg: task })
}

// After gateway responds with thread_preset_preview, auto-launch
function handleThreadPresetPreview(f) {
  // Show the generated command, then launch
  const ok = confirm(`Launch thread:\n\n${f.command}\n\nProceed?`)
  if (!ok) return
  send({ type: 'thread_launch', id: `tl-${Date.now()}`, spec: f.spec })
}

// â”€â”€ Custom builder launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.threadLaunch = function() {
  const type  = document.getElementById('thread-type-select').value
  const task  = document.getElementById('thread-task-input').value.trim()
  const agent = document.getElementById('thread-agent-input').value.trim() || undefined
  const cwd   = document.getElementById('thread-cwd-input').value.trim()   || undefined

  if (!task) { alert('Enter a task first'); return }

  let spec
  switch (type) {
    case 'base': case 'l': case 'z':
      spec = { type, task, cwd }
      break
    case 'b':
      spec = { type: 'b', task, agent: agent || 'worker', cwd }
      break
    case 'c':
      // Simple 3-step chain: scout â†’ planner â†’ worker
      spec = {
        type: 'c', cwd, skipClarify: true,
        steps: [
          { agent: 'scout',   task: `Gather context for: ${task}`, output: 'context.md' },
          { agent: 'planner', task: `Plan implementation for: ${task}`, reads: ['context.md'], output: 'plan.md' },
          { agent: agent || 'worker', task, reads: ['context.md', 'plan.md'] },
        ],
      }
      break
    case 'p':
      // 2 reviewers in parallel
      spec = {
        type: 'p', cwd,
        tasks: [
          { agent: agent || 'reviewer', task: `${task} â€” security perspective` },
          { agent: agent || 'reviewer', task: `${task} â€” performance perspective` },
        ],
      }
      break
    case 'f':
      // 3 workers, same task, fuse results
      spec = {
        type: 'f', task, cwd,
        tasks: [
          { agent: agent || 'worker', task },
          { agent: agent || 'worker', task },
          { agent: agent || 'worker', task },
        ],
      }
      break
    default:
      alert(`Unknown thread type: ${type}`)
      return
  }

  send({ type: 'thread_launch', id: `tl-${Date.now()}`, spec })
}

window.threadRefresh = function() {
  send({ type: 'thread_list',       id: 'thr-list' })
  send({ type: 'thread_agents',     id: 'thr-agents' })
  send({ type: 'thread_async_list', id: 'thr-async' })
}

window.threadKill = function(id) {
  if (!confirm(`Kill thread ${id}?`)) return
  send({ type: 'thread_kill', id: `tk-${Date.now()}`, threadId: id })
}

window.threadAbort = function(id) {
  send({ type: 'thread_abort', id: `ta-${Date.now()}`, threadId: id })
}

window.threadSteer = function(id) {
  const msg = prompt('Steer message (interrupt + redirect):')
  if (!msg) return
  send({ type: 'thread_steer', id: `ts-${Date.now()}`, threadId: id, message: msg })
}

window.toggleThreadEvents = function(id) {
  const el = document.getElementById(`thread-events-${id}`)
  if (el) el.style.display = el.style.display === 'none' ? 'flex' : 'none'
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderThreadList() {
  const el = document.getElementById('thread-list')
  const list = [...threads.values()].sort((a, b) => b.startedAt - a.startedAt)

  if (!list.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px">No threads yet.</div>'
    return
  }

  el.innerHTML = list.map(r => {
    const age = Math.round((Date.now() - r.startedAt) / 1000)
    const ageStr = age < 60 ? `${age}s` : `${Math.round(age/60)}m`
    const evts = (r.events || []).slice(-20)
    const evHtml = evts.map(ev => {
      const tc = (ev.type || '').replace(/[^a-z0-9_]/gi, '_').toLowerCase()
      const body = ev.text || ev.toolName || ''
      return body ? `<div class="thread-ev">
        <span class="thread-ev-type ${tc}">${escHtml(ev.type || '')}</span>
        <span class="thread-ev-body">${escHtml(body.slice(0, 200))}</span>
      </div>` : ''
    }).filter(Boolean).join('')

    return `<div class="thread-card ${escHtml(r.status || 'running')}" id="tcard-${escHtml(r.id)}">
      <div class="thread-card-header" onclick="toggleThreadEvents('${escHtml(r.id)}')">
        <span class="thread-type ${escHtml(r.type)}">${escHtml(r.type)}</span>
        <span class="thread-card-id">${escHtml(r.id)}</span>
        <span class="thread-card-status ${escHtml(r.status || 'running')}">${escHtml(r.status || 'running')} Â· ${ageStr}</span>
      </div>
      <div class="thread-cmd">${escHtml(r.command || '')}</div>
      <div class="thread-events" id="thread-events-${escHtml(r.id)}" style="display:flex;flex-direction:column">${evHtml}</div>
      <div class="thread-actions">
        <button onclick="threadSteer('${escHtml(r.id)}')">â†© Steer</button>
        <button onclick="threadAbort('${escHtml(r.id)}')">â¹ Abort</button>
        <button class="danger" onclick="threadKill('${escHtml(r.id)}')">âœ• Kill</button>
      </div>
    </div>`
  }).join('')
}

function appendThreadEvent(threadId, event) {
  const run = threads.get(threadId)
  if (run) {
    if (!run.events) run.events = []
    run.events.push(event)
    // Live-update the events div if visible
    const el = document.getElementById(`thread-events-${threadId}`)
    if (el && el.style.display !== 'none') {
      const body = event.text || event.toolName || ''
      if (body) {
        const tc = (event.type || '').replace(/[^a-z0-9_]/gi, '_').toLowerCase()
        el.insertAdjacentHTML('beforeend', `<div class="thread-ev">
          <span class="thread-ev-type ${tc}">${escHtml(event.type || '')}</span>
          <span class="thread-ev-body">${escHtml(body.slice(0, 200))}</span>
        </div>`)
        el.scrollTop = el.scrollHeight
      }
    }
  }
}

// â”€â”€ Frame handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleThreadFrame(f) {
  switch (f.type) {
    case 'thread_launched':
      threads.set(f.run.id, f.run)
      renderThreadList()
      break
    case 'thread_event':
      if (!threads.has(f.threadId)) threads.set(f.threadId, { id: f.threadId, events: [], status: 'running', type: '?', command: '' })
      appendThreadEvent(f.threadId, f.event)
      break
    case 'thread_idle': {
      const r = threads.get(f.threadId)
      if (r) { r.status = 'idle'; renderThreadList() }
      break
    }
    case 'thread_killed': {
      const r = threads.get(f.threadId)
      if (r) { r.status = 'killed'; renderThreadList() }
      break
    }
    case 'thread_list':
      threads.clear()
      for (const t of (f.threads || [])) threads.set(t.id, t)
      renderThreadList()
      break
    case 'thread_preset_preview':
      handleThreadPresetPreview(f)
      break
    case 'thread_agents':
      populateAgentInputs(f.agents || [])
      break
    case 'thread_async_list':
      renderAsyncJobs(f.jobs || [])
      break
  }
}

function renderAsyncJobs(jobs) {
  const el = document.getElementById('async-jobs-list')
  if (!jobs.length) { el.textContent = 'No background jobs found.'; return }
  el.innerHTML = jobs.map(j => {
    const statusColor = j.status === 'complete' ? 'var(--success)'
      : j.status === 'failed' ? 'var(--error)'
      : j.status === 'running' ? 'var(--accent)'
      : 'var(--muted)'
    const step = j.stepsTotal ? ` (${j.currentStep ?? 0}/${j.stepsTotal})` : ''
    const agents = (j.agents || []).join(', ')
    return `<div style="display:flex;gap:8px;align-items:baseline;padding:2px 0">
      <span style="color:${statusColor};min-width:70px">${escHtml(j.status ?? '?')}</span>
      <span style="color:var(--muted)">${escHtml(j.mode ?? '')}${step}</span>
      <span>${escHtml(agents)}</span>
    </div>`
  }).join('')
  // Auto-expand if any jobs
  document.getElementById('async-jobs-body').style.display = 'block'
}

function populateAgentInputs(agents) {
  const input = document.getElementById('thread-agent-input')
  if (!input) return
  // Build datalist for autocomplete
  let dl = document.getElementById('thread-agent-datalist')
  if (!dl) {
    dl = document.createElement('datalist')
    dl.id = 'thread-agent-datalist'
    input.setAttribute('list', 'thread-agent-datalist')
    input.parentNode.insertBefore(dl, input.nextSibling)
  }
  dl.innerHTML = agents.map(a =>
    `<option value="${escHtml(a.name)}" label="${escHtml(a.description)}">`
  ).join('')
  input.placeholder = agents.length
    ? `agent: ${agents.map(a => a.name).join(', ')}`
    : 'agent (scout/planner/workerâ€¦)'
}
</script>

<!-- â”€â”€ RPC Sessions tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const rpcSessions = new Map()  // sessionId â†’ { alive, events: [] }
let activeRpcSession = null

// â”€â”€ switchView â€” canonical implementation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchView = function(view) {
  const isChat    = view === 'chat'
  const isThreads = view === 'threads'
  const isRpc     = view === 'rpc'
  const isTeams   = view === 'teams'
  const isTerm    = view === 'terminal'

  document.getElementById('tab-chat')    ?.classList.toggle('active', isChat)
  document.getElementById('tab-threads') ?.classList.toggle('active', isThreads)
  document.getElementById('tab-rpc')     ?.classList.toggle('active', isRpc)
  document.getElementById('tab-teams')   ?.classList.toggle('active', isTeams)
  document.getElementById('tab-terminal')?.classList.toggle('active', isTerm)

  const main        = document.querySelector('main')
  const footer      = document.querySelector('footer')
  const threadPane  = document.getElementById('threads-pane')
  const rpcPane     = document.getElementById('rpc-pane')
  const tmsPane     = document.getElementById('teams-pane')
  const termPane    = document.getElementById('terminal-pane')

  if (main)        main.style.display   = isChat ? '' : 'none'
  if (footer)      footer.style.display = isChat ? '' : 'none'
  if (threadPane)  threadPane.classList.toggle('visible', isThreads)
  if (rpcPane)     rpcPane.classList.toggle('visible', isRpc)
  if (tmsPane)     tmsPane.classList.toggle('visible', isTeams)
  if (termPane)    termPane.classList.toggle('visible', isTerm)

  if (isThreads) threadRefresh()
  if (isRpc)     rpcRefreshList()
  if (isTeams)   teamsRefresh()
}

// â”€â”€ RPC session management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.rpcNewSession = function() {
  const cwd = document.getElementById('rpc-cwd-input').value.trim() || undefined
  const sessionId = `pi-${Date.now()}`
  send({ type: 'rpc_new', id: `rpc-new-${Date.now()}`, sessionId, cwd })
}

window.rpcRefreshList = function() {
  send({ type: 'rpc_list', id: 'rpc-list' })
}

window.rpcSend = function() {
  if (!activeRpcSession) return
  const ta = document.getElementById('rpc-prompt-input')
  const message = ta.value.trim()
  if (!message) return
  ta.value = ''
  ta.style.height = 'auto'
  send({ type: 'rpc_prompt', id: `rpc-p-${Date.now()}`, sessionId: activeRpcSession, message })
  appendRpcEvent(activeRpcSession, 'user', message)
}

window.rpcAbort = function() {
  if (!activeRpcSession) return
  send({ type: 'rpc_abort', id: `rpc-a-${Date.now()}`, sessionId: activeRpcSession })
}

window.rpcKill = function() {
  if (!activeRpcSession) return
  send({ type: 'rpc_kill', id: `rpc-k-${Date.now()}`, sessionId: activeRpcSession })
}

function activateRpcSession(sessionId) {
  activeRpcSession = sessionId
  const s = rpcSessions.get(sessionId)

  // Update list active state
  document.querySelectorAll('#rpc-session-list .pane-list-item').forEach(el => {
    el.classList.toggle('active', el.dataset.sessionId === sessionId)
  })

  // Update detail header
  document.getElementById('rpc-detail-label').textContent = 'Session'
  document.getElementById('rpc-detail-id').textContent = sessionId
  document.getElementById('rpc-abort-btn').style.display = ''
  document.getElementById('rpc-kill-btn').style.display  = ''

  // Enable prompt
  document.getElementById('rpc-prompt-input').disabled = false
  document.getElementById('rpc-send-btn').disabled = false

  // Replay events
  const stream = document.getElementById('rpc-event-stream')
  stream.innerHTML = ''
  if (s) {
    for (const ev of s.events) stream.insertAdjacentHTML('beforeend', renderRpcEventHtml(ev))
    stream.scrollTop = stream.scrollHeight
  }
}

function appendRpcEvent(sessionId, type, content) {
  const s = rpcSessions.get(sessionId)
  if (s) s.events.push({ type, content })

  if (activeRpcSession === sessionId) {
    const stream = document.getElementById('rpc-event-stream')
    stream.insertAdjacentHTML('beforeend', renderRpcEventHtml({ type, content }))
    stream.scrollTop = stream.scrollHeight
  }
}

function renderRpcEventHtml({ type, content }) {
  const typeClass = type.replace(/[^a-z0-9_]/gi, '_').toLowerCase()
  const display = type === 'user' ? 'you' : type.replace(/_/g, ' ')
  const safe = escHtml(typeof content === 'object' ? JSON.stringify(content) : String(content ?? ''))
  return `<div class="ev"><span class="ev-type ${typeClass}">${escHtml(display)}</span><span class="ev-body">${safe}</span></div>`
}

function renderRpcSessionList(sessions) {
  const el = document.getElementById('rpc-session-list')
  const count = document.getElementById('rpc-session-count')
  count.textContent = sessions.length ? `${sessions.length} session${sessions.length > 1 ? 's' : ''}` : ''

  if (!sessions.length) {
    el.innerHTML = '<div style="padding:14px;font-size:12px;color:var(--muted)">No sessions â€” create one above</div>'
    rpcSessions.clear()
    return
  }

  // Sync rpcSessions map
  const incoming = new Set(sessions.map(s => s.id))
  for (const [id] of rpcSessions) {
    if (!incoming.has(id)) rpcSessions.delete(id)
  }
  for (const s of sessions) {
    if (!rpcSessions.has(s.id)) rpcSessions.set(s.id, { alive: s.alive, events: [] })
  }

  el.innerHTML = sessions.map(s => {
    const dotClass = s.alive ? '' : 'dead'
    const isActive = s.id === activeRpcSession
    return `<div class="pane-list-item ${isActive ? 'active' : ''}" data-session-id="${escHtml(s.id)}" onclick="activateRpcSession('${escHtml(s.id)}')">
      <span class="item-dot ${dotClass}"></span>
      <span style="font-family:var(--font-mono);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(s.id)}</span>
    </div>`
  }).join('')
}

// â”€â”€ Frame handlers for RPC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleRpcFrame(f) {
  switch (f.type) {
    case 'rpc_created': {
      if (!rpcSessions.has(f.sessionId)) rpcSessions.set(f.sessionId, { alive: true, events: [] })
      rpcRefreshList()
      activateRpcSession(f.sessionId)
      break
    }
    case 'rpc_event': {
      const { sessionId, event } = f
      if (!rpcSessions.has(sessionId)) rpcSessions.set(sessionId, { alive: true, events: [] })
      const type = event?.type ?? 'event'
      let content = ''
      if (type === 'message_update') {
        content = event?.assistantMessageEvent?.delta ?? event?.assistantMessageEvent?.content ?? ''
      } else if (type === 'tool_execution_start' || type === 'tool_execution_end') {
        content = event?.toolName ?? JSON.stringify(event)
      } else {
        content = JSON.stringify(event)
      }
      appendRpcEvent(sessionId, type, content)
      break
    }
    case 'rpc_idle':
      appendRpcEvent(f.sessionId, 'turn_end', 'â€” idle â€”')
      document.getElementById('rpc-detail-label').textContent = 'Session (idle)'
      break
    case 'rpc_killed': {
      const s = rpcSessions.get(f.sessionId)
      if (s) s.alive = false
      appendRpcEvent(f.sessionId, 'error', 'session killed')
      rpcRefreshList()
      break
    }
    case 'rpc_sessions':
      renderRpcSessionList(f.sessions || [])
      break
  }
}

// Auto-resize RPC prompt
document.getElementById('rpc-prompt-input').addEventListener('input', function() {
  this.style.height = 'auto'
  this.style.height = Math.min(this.scrollHeight, 120) + 'px'
})
document.getElementById('rpc-prompt-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); window.rpcSend() }
})
</script>

<!-- â”€â”€ Agent Teams tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const teamsState = new Map()  // teamName â†’ TeamState
let activeTeamName = null
let watchingTeams = new Set()

// â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.teamsCreate = function() {
  const preset = document.getElementById('teams-preset-select').value
  const teamName = document.getElementById('teams-name-input').value.trim() || undefined
  if (!preset) { alert('Select a preset first'); return }
  send({ type: 'teams_create', id: `tc-${Date.now()}`, preset, teamName })
}

window.teamsRefresh = function() {
  send({ type: 'teams_list', id: 'tl' })
}

window.teamsSpawn = function() {
  if (!activeTeamName) return
  const cwd = document.getElementById('rpc-cwd-input').value.trim() || undefined
  send({ type: 'teams_spawn', id: `ts-${Date.now()}`, teamName: activeTeamName, cwd })
}

window.teamsToggleWatch = function() {
  if (!activeTeamName) return
  if (!watchingTeams.has(activeTeamName)) {
    watchingTeams.add(activeTeamName)
    send({ type: 'teams_watch', id: `tw-${Date.now()}`, teamName: activeTeamName })
    document.getElementById('teams-watch-btn').textContent = 'ğŸ‘ Watching'
    document.getElementById('teams-watch-btn').style.color = 'var(--success)'
  }
}

window.teamsSendMsg = function() {
  if (!activeTeamName) return
  const to = document.getElementById('teams-msg-to').value
  const content = document.getElementById('teams-msg-input').value.trim()
  if (!to || !content) return
  send({ type: 'teams_message', id: `tm-${Date.now()}`, teamName: activeTeamName,
    from: 'pi-builder', to, content })
  document.getElementById('teams-msg-input').value = ''
}

window.teamsBroadcast = function() {
  if (!activeTeamName) return
  const content = document.getElementById('teams-msg-input').value.trim()
  if (!content) return
  send({ type: 'teams_broadcast', id: `tb-${Date.now()}`, teamName: activeTeamName,
    from: 'pi-builder', content })
  document.getElementById('teams-msg-input').value = ''
}

window.teamsClearOutput = function() {
  const pre  = document.getElementById('teams-output')
  const wrap = document.getElementById('teams-output-wrap')
  if (pre)  pre.textContent = ''
  if (wrap) wrap.style.display = 'none'
}

// â”€â”€ Activate team â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function activateTeam(teamName) {
  if (activeTeamName !== teamName) teamsClearOutput()  // clear output on team switch
  activeTeamName = teamName
  document.querySelectorAll('#teams-list .pane-list-item').forEach(el => {
    el.classList.toggle('active', el.dataset.teamName === teamName)
  })

  document.getElementById('teams-detail-name').textContent = teamName
  document.getElementById('teams-detail-name').style.color = 'var(--accent)'
  document.getElementById('teams-spawn-btn').style.display = ''
  document.getElementById('teams-watch-btn').style.display = ''
  document.getElementById('teams-msg-bar').style.display = ''

  const state = teamsState.get(teamName)
  if (state) renderTeamDetail(state)
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTeamsList(states) {
  const el = document.getElementById('teams-list')
  if (!states.length) {
    el.innerHTML = '<div style="padding:14px;font-size:12px;color:var(--muted)">No teams â€” create one above</div>'
    return
  }
  teamsState.clear()
  for (const s of states) teamsState.set(s.config.teamName, s)

  el.innerHTML = states.map(s => {
    const pct = s.progress.pct
    const isActive = s.config.teamName === activeTeamName
    return `<div class="pane-list-item ${isActive ? 'active' : ''}" data-team-name="${escHtml(s.config.teamName)}" onclick="activateTeam('${escHtml(s.config.teamName)}')">
      <span class="item-dot"></span>
      <div style="flex:1;min-width:0">
        <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(s.config.teamName)}</div>
        <div style="font-size:11px;color:var(--muted)">${s.config.members.length} members Â· ${pct}%</div>
      </div>
    </div>`
  }).join('')

  if (activeTeamName) {
    const current = teamsState.get(activeTeamName)
    if (current) renderTeamDetail(current)
  }
}

function renderTeamDetail(state) {
  const { config, tasks, progress } = state

  // Members
  const membersEl = document.getElementById('teams-members')
  membersEl.innerHTML = config.members.map(m =>
    `<div class="member-row">
      <span class="item-dot"></span>
      <span>${escHtml(m.name)}</span>
      <span class="member-type">${escHtml(m.agentType)}</span>
    </div>`
  ).join('')

  // To dropdown for messages
  const toEl = document.getElementById('teams-msg-to')
  toEl.innerHTML = config.members.map(m =>
    `<option value="${escHtml(m.name)}">${escHtml(m.name)}</option>`
  ).join('')

  // Progress
  document.getElementById('teams-progress-bar').style.width = progress.pct + '%'
  document.getElementById('teams-progress-label').textContent = `${progress.completed} / ${progress.total} tasks completed`

  // Tasks
  const tasksEl = document.getElementById('teams-tasks')
  const activeTasks = tasks.filter(t => t.status !== 'deleted')
  if (!activeTasks.length) {
    tasksEl.innerHTML = '<div style="color:var(--muted);font-size:12px">No tasks yet</div>'
  } else {
    tasksEl.innerHTML = activeTasks.map(t => `
      <div class="task-card ${escHtml(t.status)}">
        <div class="task-header">
          <span class="task-status ${escHtml(t.status)}">${escHtml(t.status.replace('_', ' '))}</span>
          ${t.owner ? `<span class="task-owner">â†’ ${escHtml(t.owner)}</span>` : ''}
        </div>
        <div class="task-subject">${escHtml(t.subject)}</div>
        ${t.description ? `<div class="task-desc">${escHtml(t.description)}</div>` : ''}
      </div>`).join('')
  }
}

// â”€â”€ Frame handlers for Teams â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleTeamsFrame(f) {
  switch (f.type) {
    case 'teams_list':
      renderTeamsList(f.teams || [])
      break
    case 'teams_created':
      teamsRefresh()
      if (f.config?.teamName) activateTeam(f.config.teamName)
      break
    case 'teams_task':
    case 'teams_tasks':
      if (activeTeamName === f.teamName) {
        const state = teamsState.get(f.teamName)
        if (state) {
          if (f.tasks) state.tasks = f.tasks
          if (f.task) {
            const idx = state.tasks.findIndex(t => t.id === f.task.id)
            if (idx >= 0) state.tasks[idx] = f.task
            else state.tasks.push(f.task)
          }
          // recalculate progress
          const completed = state.tasks.filter(t => t.status === 'completed').length
          const total = state.tasks.filter(t => t.status !== 'deleted').length
          state.progress = { completed, total, pct: total ? Math.round((completed/total)*100) : 0 }
          renderTeamDetail(state)
        }
      }
      break
    case 'teams_output': {
      console.log(`[teams:${f.teamName}]`, f.text)
      const wrap = document.getElementById('teams-output-wrap')
      const pre  = document.getElementById('teams-output')
      if (wrap && pre) {
        wrap.style.display = 'flex'
        pre.textContent += f.text
        pre.scrollTop = pre.scrollHeight
      }
      break
    }
  }
}
</script>

<!-- â”€â”€ Terminal tab (ghostty-web) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script type="module">
// ghostty-web from unpkg â€” xterm.js compatible API, WASM VT100
import { init, Terminal } from 'https://unpkg.com/ghostty-web@0.4.0/dist/ghostty-web.js'

// State
const termSessions = new Map() // sessionId â†’ { term, container, tab, agentId, alive }
let activeSessionId = null
let ghosttyReady = false

// Init WASM once
init().then(() => {
  ghosttyReady = true
  console.log('[ghostty-web] WASM ready')
}).catch(err => {
  console.warn('[ghostty-web] WASM init failed, falling back to xterm.js if available:', err)
})

// â”€â”€ Terminal view side-effect hook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Main switchView is defined in the RPC Sessions script above.
// We just need to fit the active terminal when the terminal tab is selected.
;(function patchSwitchViewForTerminal() {
  const prev = window.switchView
  window.switchView = function(view) {
    prev?.(view)
    if (view === 'terminal' && activeSessionId) {
      requestAnimationFrame(() => fitTerm(activeSessionId))
    }
  }
})()

// â”€â”€ Spawn terminal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.spawnTerminal = function() {
  if (!ghosttyReady) { alert('ghostty-web WASM not ready yet â€” wait a moment'); return }
  if (!window.ws || window.ws.readyState !== WebSocket.OPEN) {
    alert('Not connected to gateway'); return
  }

  const cmdRaw = document.getElementById('term-cmd-input').value.trim() || 'pi'
  // Map friendly names to real commands
  const cmdMap = {
    pi:     ['pi', '--no-color'],
    claude: ['claude', '--print'],
    aider:  ['aider', '--no-pretty'],
    shell:  process?.platform === 'win32' ? ['cmd.exe'] : ['/bin/bash'],
  }
  const cmd = cmdMap[cmdRaw] ?? cmdRaw.split(/\s+/)
  const agentId = cmdRaw

  const id = `req-${Date.now()}`
  window.ws.send(JSON.stringify({ type: 'pty_spawn', id, agentId, cmd }))
  document.getElementById('term-status').textContent = `spawning ${agentId}â€¦`
}

// â”€â”€ Create terminal UI for a session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createTerminalForSession(sessionId, agentId, cols, rows) {
  // Container
  const containers = document.getElementById('terminal-containers')
  const container = document.createElement('div')
  container.className = 'term-container'
  container.id = `tc-${sessionId}`
  containers.appendChild(container)

  // Terminal instance
  const term = new Terminal({
    cursorBlink: true,
    fontSize: 13,
    fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace",
    theme: {
      background: '#0d0d0d',
      foreground: '#e6edf3',
      cursor: '#58a6ff',
      selectionBackground: '#264f78',
      black: '#0d1117', brightBlack: '#6e7681',
      red: '#f85149',   brightRed: '#f85149',
      green: '#3fb950', brightGreen: '#3fb950',
      yellow: '#d29922',brightYellow: '#e3b341',
      blue: '#58a6ff',  brightBlue: '#79c0ff',
      magenta: '#bc8cff',brightMagenta: '#d2a8ff',
      cyan: '#76e3ea',  brightCyan: '#b3f0ff',
      white: '#b1bac4', brightWhite: '#f0f6fc',
    },
    cols: cols || 220,
    rows: rows || 50,
    scrollback: 50000,
  })

  term.open(container)

  // Forward user input to PTY via WebSocket
  term.onData((data) => {
    if (window.ws?.readyState === WebSocket.OPEN) {
      window.ws.send(JSON.stringify({ type: 'pty_input', sessionId, data }))
    }
  })

  // Resize
  term.onResize(({ cols, rows }) => {
    if (window.ws?.readyState === WebSocket.OPEN) {
      window.ws.send(JSON.stringify({ type: 'pty_resize', sessionId, cols, rows }))
    }
  })

  // Tab
  const tabs = document.getElementById('terminal-agent-tabs')
  const addBtn = tabs.querySelector('.term-add-btn')
  const tab = document.createElement('div')
  tab.className = 'term-tab'
  tab.dataset.sessionId = sessionId
  tab.innerHTML = `
    <span class="term-dot" id="dot-${sessionId}"></span>
    <span>${agentId}</span>
    <span class="term-close" onclick="killTerminal('${sessionId}',event)">âœ•</span>
  `
  tab.addEventListener('click', (e) => {
    if (!e.target.classList.contains('term-close')) activateTerminal(sessionId)
  })
  tabs.insertBefore(tab, addBtn)

  termSessions.set(sessionId, { term, container, tab, agentId, alive: true })
  activateTerminal(sessionId)

  document.getElementById('term-status').textContent = `${agentId} running`
}

function activateTerminal(sessionId) {
  activeSessionId = sessionId
  // Hide all containers, show this one
  document.querySelectorAll('.term-container').forEach(c => c.classList.remove('active'))
  document.querySelectorAll('.term-tab').forEach(t => t.classList.remove('active'))
  const s = termSessions.get(sessionId)
  if (!s) return
  s.container.classList.add('active')
  s.tab.classList.add('active')
  fitTerm(sessionId)
}

function fitTerm(sessionId) {
  const s = termSessions.get(sessionId)
  if (!s) return
  // Basic fit: measure container, compute cols/rows from char size
  const container = s.container
  const rect = container.getBoundingClientRect()
  if (rect.width === 0) return
  // ghostty-web terminal canvas â€” approximate char dims
  const charW = 7.8   // approximate for 13px monospace
  const charH = 16
  const cols = Math.max(20, Math.floor((rect.width - 16) / charW))
  const rows = Math.max(5,  Math.floor((rect.height - 16) / charH))
  s.term.resize(cols, rows)
}

window.killTerminal = function(sessionId, e) {
  e?.stopPropagation()
  if (window.ws?.readyState === WebSocket.OPEN) {
    window.ws.send(JSON.stringify({ type: 'pty_kill', sessionId }))
  }
  const s = termSessions.get(sessionId)
  if (s) {
    s.term.dispose()
    s.container.remove()
    s.tab.remove()
    termSessions.delete(sessionId)
  }
  // Activate another session if available
  const remaining = [...termSessions.keys()]
  if (remaining.length > 0) activateTerminal(remaining[remaining.length - 1])
  else { activeSessionId = null; document.getElementById('term-status').textContent = 'no session' }
}

// â”€â”€ Handle PTY frames from WS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Hook into the existing onmessage â€” wait for ws to be defined
function hookPtyFrames() {
  if (!window.ws) { setTimeout(hookPtyFrames, 200); return }

  const origOnMessage = window.ws.onmessage
  window.ws.onmessage = (event) => {
    // Let the existing handler run first
    if (origOnMessage) origOnMessage.call(window.ws, event)

    let f
    try { f = JSON.parse(event.data) } catch { return }

    switch (f.type) {
      case 'pty_spawned':
        createTerminalForSession(f.sessionId, f.agentId, f.cols, f.rows)
        // Switch to terminal view automatically
        window.switchView('terminal')
        break

      case 'pty_data': {
        const s = termSessions.get(f.sessionId)
        if (s) s.term.write(f.data)
        break
      }

      case 'pty_exit': {
        const s = termSessions.get(f.sessionId)
        if (s) {
          s.alive = false
          s.term.write(`\r\n\x1b[31m[process exited with code ${f.exitCode}]\x1b[0m\r\n`)
          document.getElementById(`dot-${f.sessionId}`)?.classList.add('dead')
          document.getElementById('term-status').textContent = `${s.agentId} exited (${f.exitCode})`
        }
        break
      }
    }
  }
}

// Re-hook whenever WS reconnects (the main script rebinds ws)
const _origConnect = window.connect
window.connect = function() {
  _origConnect?.()
  setTimeout(hookPtyFrames, 500)
}

// Also hook now if already connected
hookPtyFrames()

// Resize observer for terminal fitting
new ResizeObserver(() => {
  if (activeSessionId) fitTerm(activeSessionId)
}).observe(document.getElementById('terminal-containers'))
</script>
</body>
</html>
