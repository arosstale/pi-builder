<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pi Builder</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #e6edf3;
    --muted:     #8b949e;
    --accent:    #58a6ff;
    --success:   #3fb950;
    --warn:      #d29922;
    --error:     #f85149;
    --user-bg:   #1c2128;
    --agent-bg:  #0d1117;
    --radius:    8px;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── Header ── */
  header {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .logo { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; color: var(--accent); }
  .logo span { color: var(--text); font-weight: 400; }

  #status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--error);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  #status-dot.connected { background: var(--success); }
  #status-dot.connecting { background: var(--warn); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  #status-label { font-size: 13px; color: var(--muted); }

  .spacer { flex: 1; }

  .agents-pill {
    font-size: 12px; color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 10px;
    cursor: pointer;
  }
  .agents-pill:hover { border-color: var(--accent); color: var(--accent); }

  .ws-input {
    font-size: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 4px 8px;
    color: var(--text);
    width: 220px;
  }
  .ws-input:focus { outline: none; border-color: var(--accent); }

  /* ── Main layout ── */
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ── Messages ── */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 820px;
    width: 100%;
    align-self: flex-start;
  }
  .msg.user { align-self: flex-end; }

  .msg-header {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-body {
    background: var(--agent-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user .msg-body {
    background: var(--user-bg);
    border-color: #3d444d;
  }

  .agent-tag {
    display: inline-block;
    font-size: 11px;
    padding: 1px 6px;
    border-radius: 4px;
    background: #1c2d40;
    color: var(--accent);
    border: 1px solid #264563;
    font-family: var(--font-mono);
  }

  /* streaming cursor */
  .cursor {
    display: inline-block;
    width: 2px; height: 14px;
    background: var(--accent);
    margin-left: 2px;
    animation: blink 1s step-end infinite;
    vertical-align: text-bottom;
  }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

  /* ── Sidebar (agent health) ── */
  #sidebar {
    width: 220px;
    border-left: 1px solid var(--border);
    background: var(--surface);
    overflow-y: auto;
    flex-shrink: 0;
    display: none;
    flex-direction: column;
  }
  #sidebar.open { display: flex; }

  .sidebar-title {
    padding: 12px 16px 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }

  .agent-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    font-size: 13px;
    font-family: var(--font-mono);
    border-bottom: 1px solid #21262d;
  }
  .agent-row .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .agent-row.ok .dot { background: var(--success); }
  .agent-row.fail .dot { background: var(--error); }

  /* ── Input area ── */
  footer {
    border-top: 1px solid var(--border);
    padding: 12px 20px;
    background: var(--surface);
    flex-shrink: 0;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  #input-box {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: var(--font-sans);
    font-size: 14px;
    line-height: 1.5;
    padding: 10px 14px;
    resize: none;
    max-height: 200px;
    overflow-y: auto;
    transition: border-color 0.15s;
  }
  #input-box:focus { outline: none; border-color: var(--accent); }
  #input-box::placeholder { color: var(--muted); }

  #send-btn {
    padding: 9px 18px;
    background: var(--accent);
    color: #0d1117;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0;
    transition: opacity 0.15s;
  }
  #send-btn:hover { opacity: 0.85; }
  #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── Status bar ── */
  #status-bar {
    padding: 3px 20px;
    font-size: 11px;
    color: var(--muted);
    background: var(--bg);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    font-family: var(--font-mono);
  }

  /* ── Agent selector bar ── */
  #agent-bar {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 6px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  #agent-bar.visible { display: flex; }
  #agent-bar::-webkit-scrollbar { display: none; }

  .agent-pill {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    white-space: nowrap;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
    flex-shrink: 0;
  }
  .agent-pill:hover { border-color: var(--accent); color: var(--accent); }
  .agent-pill.active {
    border-color: var(--accent);
    color: var(--accent);
    background: #1c2d40;
  }
  .agent-pill.auto.active {
    border-color: var(--success);
    color: var(--success);
    background: #122318;
  }
  .agent-pill.last-used {
    border-color: #3d444d;
    color: var(--text);
  }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="logo">pi<span>-builder</span></div>
  <div id="status-dot" class="connecting"></div>
  <div id="status-label">connecting…</div>
  <div class="spacer"></div>
  <input class="ws-input" id="ws-url" placeholder="ws://…">
  <button class="agents-pill" onclick="toggleSidebar()">agents</button>
</header>

<div id="agent-bar"></div>

<main>
  <div id="messages">
    <div class="msg" id="welcome">
      <div class="msg-body" style="color:var(--muted);border-color:#21262d;">
        Pi Builder routes your prompts to any installed CLI coding agent.<br>
        Type a message below to start. Make sure <code style="font-family:var(--font-mono);color:var(--accent)">pi-builder start</code> is running.
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div class="sidebar-title">Agents</div>
    <div id="agent-list"><div style="padding:12px 16px;font-size:12px;color:var(--muted)">Loading…</div></div>
  </div>
</main>

<footer>
  <textarea id="input-box" rows="1" placeholder="Ask anything about your codebase…" disabled></textarea>
  <button id="send-btn" disabled>Send</button>
</footer>

<div id="status-bar">not connected</div>

<script>
// Injected by Electron preload (undefined when running in browser)
/** @type {{ isDesktop: boolean, gatewayInfo: () => Promise<{url:string|null}>, versions: object } | undefined} */
const piBuilderDesktop = window.piBuilderDesktop

// ── State ──────────────────────────────────────────────────────────────────
let ws = null
let streaming = null   // { el: Element, cursor: Element } | null
let msgSeq = 0
let sidebarOpen = false
let pinnedAgent = null  // null = Auto, string = agent id

// ── Auto-detect WS URL ────────────────────────────────────────────────────
// When served via HTTP (e.g. http://localhost:18900/), derive WS URL from page host.
// When opened as a local file, fall back to ws://127.0.0.1:18900.
;(async function setDefaultWsUrl() {
  const input = document.getElementById('ws-url')
  if (input.value) return

  // Desktop app: ask the preload for the gateway URL
  if (window.piBuilderDesktop?.isDesktop) {
    try {
      const info = await window.piBuilderDesktop.gatewayInfo()
      if (info?.url) { input.value = info.url; return }
    } catch { /* fallthrough */ }
  }

  // Served over HTTP: derive from page host
  if (location.protocol === 'http:' || location.protocol === 'https:') {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws'
    input.value = `${proto}://${location.host}`
    return
  }

  // Local file fallback
  input.value = 'ws://127.0.0.1:18900'
})()

// ── WebSocket connection ───────────────────────────────────────────────────
function connect() {
  const url = document.getElementById('ws-url').value.trim()
  setStatus('connecting', 'connecting…')

  ws = new WebSocket(url)

  ws.onopen = () => {
    setStatus('connected', 'connected')
    setBar(`connected to ${url}`)
    enableInput(true)
    requestHealth()
  }

  ws.onclose = () => {
    setStatus('', 'disconnected')
    setBar('disconnected — reconnecting in 3s…')
    enableInput(false)
    setTimeout(connect, 3000)
  }

  ws.onerror = () => {
    setStatus('', 'error')
    setBar('connection error')
  }

  ws.onmessage = (ev) => {
    try { handleFrame(JSON.parse(ev.data)) }
    catch (e) { console.warn('bad frame', e) }
  }
}

function send(frame) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(frame))
  }
}

// ── Frame handler ──────────────────────────────────────────────────────────
function handleFrame(f) {
  switch (f.type) {
    case 'hello':
      setBar(`session: ${f.sessionId}`)
      break

    case 'user_message':
      // already rendered optimistically — skip
      break

    case 'agent_start':
      setBar(`▶ ${f.agent}: ${f.task || '…'}`)
      break

    case 'chunk':
      appendChunk(f.agent, f.text)
      break

    case 'turn_complete':
      finishStream(f.message)
      setBar(`✓ ${f.message?.agentUsed || ''} — ${f.message?.durationMs || 0}ms`)
      if (f.message?.agentUsed) flashLastUsed(f.message.agentUsed)
      break

    case 'agent_end':
      break

    case 'error':
      finishStream(null)
      appendError(f.message)
      setBar(`❌ ${f.message}`)
      enableInput(true)
      break

    case 'health':
      renderHealth(f.agents)
      break

    case 'agents':
      renderAgentList(f.list)
      break

    case 'history':
      renderHistory(f.messages)
      break

    case 'ok':
      break
  }
}

// ── Streaming ─────────────────────────────────────────────────────────────
function appendChunk(agent, text) {
  if (!streaming) {
    const id = ++msgSeq
    const html = `
      <div class="msg" id="msg-${id}">
        <div class="msg-header">
          <span class="agent-tag">${escHtml(agent)}</span>
        </div>
        <div class="msg-body" id="body-${id}"></div>
      </div>`
    document.getElementById('messages').insertAdjacentHTML('beforeend', html)
    const cursor = document.createElement('span')
    cursor.className = 'cursor'
    const body = document.getElementById(`body-${id}`)
    body.appendChild(cursor)
    streaming = { body, cursor }
  }
  streaming.cursor.insertAdjacentText('beforebegin', text)
  scrollBottom()
}

function finishStream(message) {
  if (streaming) {
    streaming.cursor.remove()
    streaming = null
  }
  enableInput(true)
}

// ── Message rendering ──────────────────────────────────────────────────────
function addUserMsg(text) {
  const id = ++msgSeq
  const ts = new Date().toLocaleTimeString()
  document.getElementById('messages').insertAdjacentHTML('beforeend', `
    <div class="msg user" id="msg-${id}">
      <div class="msg-header" style="justify-content:flex-end">
        <span style="color:var(--muted)">${ts}</span> you
      </div>
      <div class="msg-body">${escHtml(text)}</div>
    </div>`)
  scrollBottom()
}

function appendError(msg) {
  document.getElementById('messages').insertAdjacentHTML('beforeend', `
    <div class="msg">
      <div class="msg-body" style="color:var(--error);border-color:#531e1e">${escHtml(msg)}</div>
    </div>`)
  scrollBottom()
}

function renderHistory(messages) {
  if (!messages || messages.length === 0) return
  const container = document.getElementById('messages')
  // Clear welcome
  const welcome = document.getElementById('welcome')
  if (welcome) welcome.remove()

  for (const m of messages) {
    const id = ++msgSeq
    const role = m.role === 'user' ? 'user' : ''
    const header = m.role === 'user'
      ? `<div class="msg-header" style="justify-content:flex-end">you</div>`
      : `<div class="msg-header"><span class="agent-tag">${escHtml(m.agentUsed || 'assistant')}</span></div>`
    container.insertAdjacentHTML('beforeend', `
      <div class="msg ${role}" id="msg-${id}">
        ${header}
        <div class="msg-body">${escHtml(m.content)}</div>
      </div>`)
  }
  scrollBottom()
}

// ── Health / agents ────────────────────────────────────────────────────────
function requestHealth() {
  send({ type: 'agents', id: 'init-agents' })
}

function renderAgentList(list) {
  // Sidebar
  const el = document.getElementById('agent-list')
  if (!list || list.length === 0) {
    el.innerHTML = '<div style="padding:12px 16px;font-size:12px;color:var(--muted)">No agents found</div>'
    return
  }
  el.innerHTML = list.map(a =>
    `<div class="agent-row ok">
      <div class="dot"></div>
      <span>${escHtml(a.id)}</span>
    </div>`
  ).join('')

  // Agent selector bar
  const bar = document.getElementById('agent-bar')
  bar.innerHTML = ''

  const autoPill = document.createElement('button')
  autoPill.className = 'agent-pill auto' + (pinnedAgent === null ? ' active' : '')
  autoPill.textContent = 'Auto'
  autoPill.title = 'Route to best available agent'
  autoPill.addEventListener('click', () => setPinnedAgent(null))
  bar.appendChild(autoPill)

  for (const a of list) {
    const pill = document.createElement('button')
    pill.className = 'agent-pill' + (pinnedAgent === a.id ? ' active' : '')
    pill.textContent = a.id
    pill.title = a.capabilities?.join(', ') || a.id
    pill.dataset.agentId = a.id
    pill.addEventListener('click', () => setPinnedAgent(a.id))
    bar.appendChild(pill)
  }

  bar.classList.add('visible')
}

function setPinnedAgent(agentId) {
  pinnedAgent = agentId
  // Update pill active states
  const bar = document.getElementById('agent-bar')
  bar.querySelectorAll('.agent-pill').forEach(p => {
    p.classList.remove('active', 'last-used')
    const isAuto = p.classList.contains('auto')
    const matches = isAuto ? agentId === null : p.dataset.agentId === agentId
    if (matches) p.classList.add('active')
  })
  // Update placeholder
  const input = document.getElementById('input-box')
  input.placeholder = agentId
    ? `Ask ${agentId}…`
    : 'Ask anything about your codebase…'
}

function flashLastUsed(agentId) {
  if (pinnedAgent !== null) return  // pinned — don't flash
  const bar = document.getElementById('agent-bar')
  bar.querySelectorAll('.agent-pill').forEach(p => p.classList.remove('last-used'))
  const pill = bar.querySelector(`[data-agent-id="${CSS.escape(agentId)}"]`)
  if (pill) pill.classList.add('last-used')
}

function renderHealth(agents) {
  if (!agents) return

  // Sidebar: show all agents with health dot
  const el = document.getElementById('agent-list')
  el.innerHTML = Object.entries(agents).map(([id, ok]) =>
    `<div class="agent-row ${ok ? 'ok' : 'fail'}">
      <div class="dot"></div>
      <span>${escHtml(id)}</span>
    </div>`
  ).join('')

  // Pill bar: dim pills for unhealthy agents; don't touch active/last-used state
  const bar = document.getElementById('agent-bar')
  if (!bar.classList.contains('visible')) return
  bar.querySelectorAll('.agent-pill[data-agent-id]').forEach(p => {
    const ok = agents[p.dataset.agentId]
    p.style.opacity = ok === false ? '0.35' : ''
    p.title = ok === false ? `${p.dataset.agentId} — not available` : (p.dataset.agentId ?? '')
  })
}

// ── Send ───────────────────────────────────────────────────────────────────
function sendMessage() {
  const input = document.getElementById('input-box')
  const text = input.value.trim()
  if (!text) return

  addUserMsg(text)
  input.value = ''
  input.style.height = 'auto'
  enableInput(false)

  // If an agent is pinned, prepend @agentid (middleware handles routing)
  const message = pinnedAgent ? `@${pinnedAgent} ${text}` : text
  send({ type: 'send', id: `msg-${Date.now()}`, message })
}

// ── UI helpers ─────────────────────────────────────────────────────────────
function toggleSidebar() {
  sidebarOpen = !sidebarOpen
  document.getElementById('sidebar').classList.toggle('open', sidebarOpen)
  if (sidebarOpen) send({ type: 'health', id: 'sidebar-health' })
}

function setStatus(cls, label) {
  const dot = document.getElementById('status-dot')
  dot.className = cls
  document.getElementById('status-label').textContent = label
}

function setBar(text) {
  document.getElementById('status-bar').textContent = text
}

function enableInput(on) {
  document.getElementById('input-box').disabled = !on
  document.getElementById('send-btn').disabled = !on
  if (on) document.getElementById('input-box').focus()
}

function scrollBottom() {
  const el = document.getElementById('messages')
  el.scrollTop = el.scrollHeight
}

function escHtml(str) {
  return String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
}

// ── Event listeners ────────────────────────────────────────────────────────
document.getElementById('send-btn').addEventListener('click', sendMessage)

document.getElementById('input-box').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault()
    sendMessage()
  }
})

// Auto-resize textarea
document.getElementById('input-box').addEventListener('input', function () {
  this.style.height = 'auto'
  this.style.height = Math.min(this.scrollHeight, 200) + 'px'
})

// Reconnect on URL change
document.getElementById('ws-url').addEventListener('change', () => {
  if (ws) ws.close()
})

// ── Boot ──────────────────────────────────────────────────────────────────
connect()
</script>
</body>
</html>
