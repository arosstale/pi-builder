<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pi Builder</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0d1117;
    --surface:   #161b22;
    --border:    #30363d;
    --text:      #e6edf3;
    --muted:     #8b949e;
    --accent:    #58a6ff;
    --success:   #3fb950;
    --warn:      #d29922;
    --error:     #f85149;
    --user-bg:   #1c2128;
    --agent-bg:  #0d1117;
    --radius:    8px;
    --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── Header ── */
  header {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .logo { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; color: var(--accent); }
  .logo span { color: var(--text); font-weight: 400; }

  #status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--error);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  #status-dot.connected { background: var(--success); }
  #status-dot.connecting { background: var(--warn); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  #status-label { font-size: 13px; color: var(--muted); }

  .spacer { flex: 1; }

  .agents-pill {
    font-size: 12px; color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 3px 10px;
    cursor: pointer;
  }
  .agents-pill:hover { border-color: var(--accent); color: var(--accent); }

  .ws-input {
    font-size: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 4px 8px;
    color: var(--text);
    width: 220px;
  }
  .ws-input:focus { outline: none; border-color: var(--accent); }

  /* ── Main layout ── */
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ── Messages ── */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 820px;
    width: 100%;
    align-self: flex-start;
  }
  .msg.user { align-self: flex-end; }

  .msg-header {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-body {
    background: var(--agent-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user .msg-body {
    background: var(--user-bg);
    border-color: #3d444d;
  }

  .agent-tag {
    display: inline-block;
    font-size: 11px;
    padding: 1px 6px;
    border-radius: 4px;
    background: #1c2d40;
    color: var(--accent);
    border: 1px solid #264563;
    font-family: var(--font-mono);
  }

  /* streaming cursor */
  .cursor {
    display: inline-block;
    width: 2px; height: 14px;
    background: var(--accent);
    margin-left: 2px;
    animation: blink 1s step-end infinite;
    vertical-align: text-bottom;
  }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0; } }

  /* ── Sidebar (agent health + git diff) ── */
  #sidebar {
    width: 260px;
    border-left: 1px solid var(--border);
    background: var(--surface);
    overflow-y: auto;
    flex-shrink: 0;
    display: none;
    flex-direction: column;
  }
  #sidebar.open { display: flex; }

  /* git diff panel */
  #diff-panel {
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  #diff-panel .sidebar-title { border-bottom: 1px solid var(--border); }
  #diff-content {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 8px 12px;
    white-space: pre-wrap;
    word-break: break-all;
    color: var(--muted);
    max-height: 200px;
    overflow-y: auto;
  }
  #diff-content.has-diff { color: var(--text); }

  /* message queue badge */
  #queue-badge {
    display: none;
    position: absolute;
    top: -6px; right: -6px;
    background: var(--warn);
    color: #0d1117;
    font-size: 10px;
    font-weight: 700;
    border-radius: 10px;
    padding: 1px 5px;
    min-width: 16px;
    text-align: center;
  }
  #send-wrap { position: relative; flex-shrink: 0; }

  .sidebar-title {
    padding: 12px 16px 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }

  .agent-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    font-size: 13px;
    font-family: var(--font-mono);
    border-bottom: 1px solid #21262d;
  }
  .agent-row .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .agent-row.ok .dot { background: var(--success); }
  .agent-row.fail .dot { background: var(--error); }

  /* ── Input area ── */
  footer {
    border-top: 1px solid var(--border);
    padding: 12px 20px;
    background: var(--surface);
    flex-shrink: 0;
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  #input-box {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: var(--font-sans);
    font-size: 14px;
    line-height: 1.5;
    padding: 10px 14px;
    resize: none;
    max-height: 200px;
    overflow-y: auto;
    transition: border-color 0.15s;
  }
  #input-box:focus { outline: none; border-color: var(--accent); }
  #input-box::placeholder { color: var(--muted); }

  #send-btn {
    padding: 9px 18px;
    background: var(--accent);
    color: #0d1117;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    flex-shrink: 0;
    transition: opacity 0.15s;
  }
  #send-btn:hover { opacity: 0.85; }
  #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ── Status bar ── */
  #status-bar {
    padding: 3px 20px;
    font-size: 11px;
    color: var(--muted);
    background: var(--bg);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    font-family: var(--font-mono);
  }

  /* ── Agent selector bar ── */
  #agent-bar {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 6px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  #agent-bar.visible { display: flex; }
  #agent-bar::-webkit-scrollbar { display: none; }

  .agent-pill {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    white-space: nowrap;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
    flex-shrink: 0;
  }
  .agent-pill:hover { border-color: var(--accent); color: var(--accent); }
  .agent-pill.active {
    border-color: var(--accent);
    color: var(--accent);
    background: #1c2d40;
  }
  .agent-pill.auto.active {
    border-color: var(--success);
    color: var(--success);
    background: #122318;
  }
  .agent-pill.last-used {
    border-color: #3d444d;
    color: var(--text);
  }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* ── View tabs ── */
  .view-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    padding: 0 20px;
  }
  .view-tab {
    font-size: 12px;
    padding: 7px 14px;
    cursor: pointer;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    user-select: none;
    transition: color 0.15s, border-color 0.15s;
  }
  .view-tab:hover { color: var(--text); }
  .view-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* ── Terminal pane ── */
  #terminal-pane {
    display: none;
    flex: 1;
    flex-direction: column;
    overflow: hidden;
    background: #0d0d0d;
  }
  #terminal-pane.visible { display: flex; }

  #terminal-agent-tabs {
    display: flex;
    gap: 0;
    background: #111;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  #terminal-agent-tabs::-webkit-scrollbar { display: none; }

  .term-tab {
    font-size: 11px;
    font-family: var(--font-mono);
    padding: 6px 14px;
    cursor: pointer;
    color: var(--muted);
    border-right: 1px solid var(--border);
    white-space: nowrap;
    transition: background 0.15s, color 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .term-tab:hover { background: #1a1a1a; color: var(--text); }
  .term-tab.active { background: #0d0d0d; color: var(--accent); }
  .term-tab .term-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--success);
    flex-shrink: 0;
  }
  .term-tab .term-dot.dead { background: var(--error); }
  .term-tab .term-close {
    opacity: 0.5;
    font-size: 10px;
    margin-left: 4px;
    line-height: 1;
  }
  .term-tab .term-close:hover { opacity: 1; color: var(--error); }

  .term-add-btn {
    font-size: 18px;
    padding: 0 12px;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .term-add-btn:hover { color: var(--accent); }

  #terminal-containers {
    flex: 1;
    position: relative;
    overflow: hidden;
  }
  .term-container {
    position: absolute;
    inset: 0;
    padding: 8px;
    display: none;
  }
  .term-container.active { display: block; }

  #terminal-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    background: #111;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
  }
  #terminal-toolbar input {
    flex: 1;
    background: #0d0d0d;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px 8px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 11px;
  }
  #terminal-toolbar input:focus { outline: none; border-color: var(--accent); }
  #terminal-toolbar button {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px 10px;
    color: var(--text);
    font-size: 11px;
    cursor: pointer;
  }
  #terminal-toolbar button:hover { border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<header>
  <div class="logo">pi<span>-builder</span></div>
  <div id="status-dot" class="connecting"></div>
  <div id="status-label">connecting…</div>
  <div class="spacer"></div>
  <input class="ws-input" id="ws-url" placeholder="ws://…">
  <button class="agents-pill" onclick="toggleSidebar()">agents</button>
</header>

<div id="agent-bar"></div>

<div class="view-tabs">
  <div class="view-tab active" id="tab-chat" onclick="switchView('chat')">Chat</div>
  <div class="view-tab" id="tab-terminal" onclick="switchView('terminal')">Terminal</div>
</div>

<main>
  <div id="messages">
    <div class="msg" id="welcome">
      <div class="msg-body" style="color:var(--muted);border-color:#21262d;">
        Pi Builder routes your prompts to any installed CLI coding agent.<br>
        Type a message below to start. Make sure <code style="font-family:var(--font-mono);color:var(--accent)">pi-builder start</code> is running.
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div class="sidebar-title">Agents</div>
    <div id="agent-list"><div style="padding:12px 16px;font-size:12px;color:var(--muted)">Loading…</div></div>
    <div id="diff-panel">
      <div class="sidebar-title">Git Diff</div>
      <div id="diff-content">no changes yet</div>
    </div>
  </div>
</main>

<!-- Terminal pane (ghostty-web) -->
<div id="terminal-pane">
  <div id="terminal-agent-tabs">
    <div class="term-add-btn" onclick="spawnTerminal()" title="New terminal">+</div>
  </div>
  <div id="terminal-containers"></div>
  <div id="terminal-toolbar">
    <span>cmd:</span>
    <input id="term-cmd-input" placeholder="pi  /  claude  /  aider  /  shell" value="pi">
    <button onclick="spawnTerminal()">Spawn</button>
    <span id="term-status" style="margin-left:auto">no session</span>
  </div>
</div>

<footer>
  <textarea id="input-box" rows="1" placeholder="Ask anything about your codebase…" disabled></textarea>
  <div id="send-wrap">
    <button id="send-btn" disabled>Send</button>
    <span id="queue-badge">0</span>
  </div>
</footer>

<div id="status-bar">not connected</div>

<script>
// Injected by Electron preload (undefined when running in browser)
/** @type {{ isDesktop: boolean, gatewayInfo: () => Promise<{url:string|null}>, versions: object } | undefined} */
const piBuilderDesktop = window.piBuilderDesktop

// ── State ──────────────────────────────────────────────────────────────────
let ws = null
let streaming = null   // { el: Element, cursor: Element } | null
let msgSeq = 0
let sidebarOpen = false
let pinnedAgent = null  // null = Auto, string = agent id
let queueCount = 0

// ── Auto-detect WS URL ────────────────────────────────────────────────────
// When served via HTTP (e.g. http://localhost:18900/), derive WS URL from page host.
// When opened as a local file, fall back to ws://127.0.0.1:18900.
;(async function setDefaultWsUrl() {
  const input = document.getElementById('ws-url')
  if (input.value) return

  // Desktop app: ask the preload for the gateway URL
  if (window.piBuilderDesktop?.isDesktop) {
    try {
      const info = await window.piBuilderDesktop.gatewayInfo()
      if (info?.url) { input.value = info.url; return }
    } catch { /* fallthrough */ }
  }

  // Served over HTTP: derive from page host
  if (location.protocol === 'http:' || location.protocol === 'https:') {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws'
    input.value = `${proto}://${location.host}`
    return
  }

  // Local file fallback
  input.value = 'ws://127.0.0.1:18900'
})()

// ── WebSocket connection ───────────────────────────────────────────────────
function connect() {
  const url = document.getElementById('ws-url').value.trim()
  setStatus('connecting', 'connecting…')

  ws = new WebSocket(url)

  ws.onopen = () => {
    setStatus('connected', 'connected')
    setBar(`connected to ${url}`)
    enableInput(true)
    requestHealth()
    // Restore session history on (re)connect
    send({ type: 'history', id: 'restore' })
  }

  ws.onclose = () => {
    setStatus('', 'disconnected')
    setBar('disconnected — reconnecting in 3s…')
    enableInput(false)
    setTimeout(connect, 3000)
  }

  ws.onerror = () => {
    setStatus('', 'error')
    setBar('connection error')
  }

  ws.onmessage = (ev) => {
    try { handleFrame(JSON.parse(ev.data)) }
    catch (e) { console.warn('bad frame', e) }
  }
}

function send(frame) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(frame))
  }
}

// ── Frame handler ──────────────────────────────────────────────────────────
function handleFrame(f) {
  switch (f.type) {
    case 'hello':
      setBar(`session: ${f.sessionId}`)
      break

    case 'user_message':
      // already rendered optimistically — skip
      break

    case 'agent_start':
      setBar(`▶ ${f.agent}: ${f.task || '…'}`)
      break

    case 'chunk':
      appendChunk(f.agent, f.text)
      break

    case 'turn_complete':
      finishStream(f.message)
      setBar(`✓ ${f.message?.agentUsed || ''} — ${f.message?.durationMs || 0}ms`)
      if (f.message?.agentUsed) flashLastUsed(f.message.agentUsed)
      // Queue count decrements as turns complete
      if (queueCount > 0) { queueCount--; updateQueueBadge() }
      break

    case 'agent_end':
      break

    case 'error':
      finishStream(null)
      appendError(f.message)
      setBar(`❌ ${f.message}`)
      enableInput(true)
      break

    case 'health':
      renderHealth(f.agents)
      break

    case 'agents':
      renderAgentList(f.list)
      break

    case 'history':
      renderHistory(f.messages)
      break

    case 'diff':
      renderDiff(f.diff)
      break

    case 'queued':
      queueCount = f.queueLength || 0
      updateQueueBadge()
      break

    case 'ok':
      break
  }
}

// ── Streaming ─────────────────────────────────────────────────────────────
function appendChunk(agent, text) {
  if (!streaming) {
    const id = ++msgSeq
    const html = `
      <div class="msg" id="msg-${id}">
        <div class="msg-header">
          <span class="agent-tag">${escHtml(agent)}</span>
        </div>
        <div class="msg-body" id="body-${id}"></div>
      </div>`
    document.getElementById('messages').insertAdjacentHTML('beforeend', html)
    const cursor = document.createElement('span')
    cursor.className = 'cursor'
    const body = document.getElementById(`body-${id}`)
    body.appendChild(cursor)
    streaming = { body, cursor }
  }
  streaming.cursor.insertAdjacentText('beforebegin', text)
  scrollBottom()
}

function finishStream(message) {
  if (streaming) {
    streaming.cursor.remove()
    streaming = null
  }
  enableInput(true)
}

// ── Message rendering ──────────────────────────────────────────────────────
function addUserMsg(text) {
  const id = ++msgSeq
  const ts = new Date().toLocaleTimeString()
  document.getElementById('messages').insertAdjacentHTML('beforeend', `
    <div class="msg user" id="msg-${id}">
      <div class="msg-header" style="justify-content:flex-end">
        <span style="color:var(--muted)">${ts}</span> you
      </div>
      <div class="msg-body">${escHtml(text)}</div>
    </div>`)
  scrollBottom()
}

function appendError(msg) {
  document.getElementById('messages').insertAdjacentHTML('beforeend', `
    <div class="msg">
      <div class="msg-body" style="color:var(--error);border-color:#531e1e">${escHtml(msg)}</div>
    </div>`)
  scrollBottom()
}

function renderHistory(messages) {
  if (!messages || messages.length === 0) return
  const container = document.getElementById('messages')
  // Clear existing messages + welcome to avoid duplicates on reconnect
  container.innerHTML = ''

  for (const m of messages) {
    const id = ++msgSeq
    const role = m.role === 'user' ? 'user' : ''
    const header = m.role === 'user'
      ? `<div class="msg-header" style="justify-content:flex-end">you</div>`
      : `<div class="msg-header"><span class="agent-tag">${escHtml(m.agentUsed || 'assistant')}</span></div>`
    container.insertAdjacentHTML('beforeend', `
      <div class="msg ${role}" id="msg-${id}">
        ${header}
        <div class="msg-body">${escHtml(m.content)}</div>
      </div>`)
  }
  scrollBottom()
}

// ── Health / agents ────────────────────────────────────────────────────────
function requestHealth() {
  send({ type: 'agents', id: 'init-agents' })
}

function renderAgentList(list) {
  // Sidebar
  const el = document.getElementById('agent-list')
  if (!list || list.length === 0) {
    el.innerHTML = '<div style="padding:12px 16px;font-size:12px;color:var(--muted)">No agents found</div>'
    return
  }
  el.innerHTML = list.map(a =>
    `<div class="agent-row ok">
      <div class="dot"></div>
      <span>${escHtml(a.id)}</span>
    </div>`
  ).join('')

  // Agent selector bar
  const bar = document.getElementById('agent-bar')
  bar.innerHTML = ''

  const autoPill = document.createElement('button')
  autoPill.className = 'agent-pill auto' + (pinnedAgent === null ? ' active' : '')
  autoPill.textContent = 'Auto'
  autoPill.title = 'Route to best available agent'
  autoPill.addEventListener('click', () => setPinnedAgent(null))
  bar.appendChild(autoPill)

  for (const a of list) {
    const pill = document.createElement('button')
    pill.className = 'agent-pill' + (pinnedAgent === a.id ? ' active' : '')
    pill.textContent = a.id
    pill.title = a.capabilities?.join(', ') || a.id
    pill.dataset.agentId = a.id
    pill.addEventListener('click', () => setPinnedAgent(a.id))
    bar.appendChild(pill)
  }

  bar.classList.add('visible')
}

function setPinnedAgent(agentId) {
  pinnedAgent = agentId
  // Update pill active states
  const bar = document.getElementById('agent-bar')
  bar.querySelectorAll('.agent-pill').forEach(p => {
    p.classList.remove('active', 'last-used')
    const isAuto = p.classList.contains('auto')
    const matches = isAuto ? agentId === null : p.dataset.agentId === agentId
    if (matches) p.classList.add('active')
  })
  // Update placeholder
  const input = document.getElementById('input-box')
  input.placeholder = agentId
    ? `Ask ${agentId}…`
    : 'Ask anything about your codebase…'
}

function renderDiff(diff) {
  const el = document.getElementById('diff-content')
  if (!diff) {
    el.textContent = 'no changes'
    el.classList.remove('has-diff')
    return
  }
  el.textContent = diff
  el.classList.add('has-diff')
  // Auto-open sidebar if diff arrives and sidebar is closed
  if (!sidebarOpen) {
    sidebarOpen = true
    document.getElementById('sidebar').classList.add('open')
  }
}

function updateQueueBadge() {
  const badge = document.getElementById('queue-badge')
  if (queueCount > 0) {
    badge.textContent = queueCount
    badge.style.display = 'block'
  } else {
    badge.style.display = 'none'
  }
}

function flashLastUsed(agentId) {
  if (pinnedAgent !== null) return  // pinned — don't flash
  const bar = document.getElementById('agent-bar')
  bar.querySelectorAll('.agent-pill').forEach(p => p.classList.remove('last-used'))
  const pill = bar.querySelector(`[data-agent-id="${CSS.escape(agentId)}"]`)
  if (pill) pill.classList.add('last-used')
}

function renderHealth(agents) {
  if (!agents) return

  // Sidebar: show all agents with health dot
  const el = document.getElementById('agent-list')
  el.innerHTML = Object.entries(agents).map(([id, ok]) =>
    `<div class="agent-row ${ok ? 'ok' : 'fail'}">
      <div class="dot"></div>
      <span>${escHtml(id)}</span>
    </div>`
  ).join('')

  // Pill bar: dim pills for unhealthy agents; don't touch active/last-used state
  const bar = document.getElementById('agent-bar')
  if (!bar.classList.contains('visible')) return
  bar.querySelectorAll('.agent-pill[data-agent-id]').forEach(p => {
    const ok = agents[p.dataset.agentId]
    p.style.opacity = ok === false ? '0.35' : ''
    p.title = ok === false ? `${p.dataset.agentId} — not available` : (p.dataset.agentId ?? '')
  })
}

// ── Send ───────────────────────────────────────────────────────────────────
function sendMessage() {
  const input = document.getElementById('input-box')
  const text = input.value.trim()
  if (!text) return

  addUserMsg(text)
  input.value = ''
  input.style.height = 'auto'
  enableInput(false)

  // If an agent is pinned, prepend @agentid (middleware handles routing)
  const message = pinnedAgent ? `@${pinnedAgent} ${text}` : text
  send({ type: 'send', id: `msg-${Date.now()}`, message })
}

// ── UI helpers ─────────────────────────────────────────────────────────────
function toggleSidebar() {
  sidebarOpen = !sidebarOpen
  document.getElementById('sidebar').classList.toggle('open', sidebarOpen)
  if (sidebarOpen) send({ type: 'health', id: 'sidebar-health' })
}

function setStatus(cls, label) {
  const dot = document.getElementById('status-dot')
  dot.className = cls
  document.getElementById('status-label').textContent = label
}

function setBar(text) {
  document.getElementById('status-bar').textContent = text
}

function enableInput(on) {
  document.getElementById('input-box').disabled = !on
  document.getElementById('send-btn').disabled = !on
  if (on) document.getElementById('input-box').focus()
}

function scrollBottom() {
  const el = document.getElementById('messages')
  el.scrollTop = el.scrollHeight
}

function escHtml(str) {
  return String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
}

// ── Event listeners ────────────────────────────────────────────────────────
document.getElementById('send-btn').addEventListener('click', sendMessage)

document.getElementById('input-box').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault()
    sendMessage()
  }
})

// Auto-resize textarea
document.getElementById('input-box').addEventListener('input', function () {
  this.style.height = 'auto'
  this.style.height = Math.min(this.scrollHeight, 200) + 'px'
})

// Reconnect on URL change
document.getElementById('ws-url').addEventListener('change', () => {
  if (ws) ws.close()
})

// ── Boot ──────────────────────────────────────────────────────────────────
connect()
</script>

<!-- ── Terminal tab (ghostty-web) ───────────────────────────────────────── -->
<script type="module">
// ghostty-web from unpkg — xterm.js compatible API, WASM VT100
import { init, Terminal } from 'https://unpkg.com/ghostty-web@0.4.0/dist/ghostty-web.js'

// State
const termSessions = new Map() // sessionId → { term, container, tab, agentId, alive }
let activeSessionId = null
let ghosttyReady = false

// Init WASM once
init().then(() => {
  ghosttyReady = true
  console.log('[ghostty-web] WASM ready')
}).catch(err => {
  console.warn('[ghostty-web] WASM init failed, falling back to xterm.js if available:', err)
})

// ── View switching ──────────────────────────────────────────────────────
window.switchView = function(view) {
  document.getElementById('tab-chat').classList.toggle('active', view === 'chat')
  document.getElementById('tab-terminal').classList.toggle('active', view === 'terminal')

  const main = document.querySelector('main')
  const termPane = document.getElementById('terminal-pane')
  const footer = document.querySelector('footer')

  if (view === 'terminal') {
    main.style.display = 'none'
    footer.style.display = 'none'
    termPane.classList.add('visible')
    // fit active terminal on show
    if (activeSessionId) fitTerm(activeSessionId)
  } else {
    main.style.display = ''
    footer.style.display = ''
    termPane.classList.remove('visible')
  }
}

// ── Spawn terminal ──────────────────────────────────────────────────────
window.spawnTerminal = function() {
  if (!ghosttyReady) { alert('ghostty-web WASM not ready yet — wait a moment'); return }
  if (!window.ws || window.ws.readyState !== WebSocket.OPEN) {
    alert('Not connected to gateway'); return
  }

  const cmdRaw = document.getElementById('term-cmd-input').value.trim() || 'pi'
  // Map friendly names to real commands
  const cmdMap = {
    pi:     ['pi', '--no-color'],
    claude: ['claude', '--print'],
    aider:  ['aider', '--no-pretty'],
    shell:  process?.platform === 'win32' ? ['cmd.exe'] : ['/bin/bash'],
  }
  const cmd = cmdMap[cmdRaw] ?? cmdRaw.split(/\s+/)
  const agentId = cmdRaw

  const id = `req-${Date.now()}`
  window.ws.send(JSON.stringify({ type: 'pty_spawn', id, agentId, cmd }))
  document.getElementById('term-status').textContent = `spawning ${agentId}…`
}

// ── Create terminal UI for a session ───────────────────────────────────
function createTerminalForSession(sessionId, agentId, cols, rows) {
  // Container
  const containers = document.getElementById('terminal-containers')
  const container = document.createElement('div')
  container.className = 'term-container'
  container.id = `tc-${sessionId}`
  containers.appendChild(container)

  // Terminal instance
  const term = new Terminal({
    cursorBlink: true,
    fontSize: 13,
    fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace",
    theme: {
      background: '#0d0d0d',
      foreground: '#e6edf3',
      cursor: '#58a6ff',
      selectionBackground: '#264f78',
      black: '#0d1117', brightBlack: '#6e7681',
      red: '#f85149',   brightRed: '#f85149',
      green: '#3fb950', brightGreen: '#3fb950',
      yellow: '#d29922',brightYellow: '#e3b341',
      blue: '#58a6ff',  brightBlue: '#79c0ff',
      magenta: '#bc8cff',brightMagenta: '#d2a8ff',
      cyan: '#76e3ea',  brightCyan: '#b3f0ff',
      white: '#b1bac4', brightWhite: '#f0f6fc',
    },
    cols: cols || 220,
    rows: rows || 50,
    scrollback: 50000,
  })

  term.open(container)

  // Forward user input to PTY via WebSocket
  term.onData((data) => {
    if (window.ws?.readyState === WebSocket.OPEN) {
      window.ws.send(JSON.stringify({ type: 'pty_input', sessionId, data }))
    }
  })

  // Resize
  term.onResize(({ cols, rows }) => {
    if (window.ws?.readyState === WebSocket.OPEN) {
      window.ws.send(JSON.stringify({ type: 'pty_resize', sessionId, cols, rows }))
    }
  })

  // Tab
  const tabs = document.getElementById('terminal-agent-tabs')
  const addBtn = tabs.querySelector('.term-add-btn')
  const tab = document.createElement('div')
  tab.className = 'term-tab'
  tab.dataset.sessionId = sessionId
  tab.innerHTML = `
    <span class="term-dot" id="dot-${sessionId}"></span>
    <span>${agentId}</span>
    <span class="term-close" onclick="killTerminal('${sessionId}',event)">✕</span>
  `
  tab.addEventListener('click', (e) => {
    if (!e.target.classList.contains('term-close')) activateTerminal(sessionId)
  })
  tabs.insertBefore(tab, addBtn)

  termSessions.set(sessionId, { term, container, tab, agentId, alive: true })
  activateTerminal(sessionId)

  document.getElementById('term-status').textContent = `${agentId} running`
}

function activateTerminal(sessionId) {
  activeSessionId = sessionId
  // Hide all containers, show this one
  document.querySelectorAll('.term-container').forEach(c => c.classList.remove('active'))
  document.querySelectorAll('.term-tab').forEach(t => t.classList.remove('active'))
  const s = termSessions.get(sessionId)
  if (!s) return
  s.container.classList.add('active')
  s.tab.classList.add('active')
  fitTerm(sessionId)
}

function fitTerm(sessionId) {
  const s = termSessions.get(sessionId)
  if (!s) return
  // Basic fit: measure container, compute cols/rows from char size
  const container = s.container
  const rect = container.getBoundingClientRect()
  if (rect.width === 0) return
  // ghostty-web terminal canvas — approximate char dims
  const charW = 7.8   // approximate for 13px monospace
  const charH = 16
  const cols = Math.max(20, Math.floor((rect.width - 16) / charW))
  const rows = Math.max(5,  Math.floor((rect.height - 16) / charH))
  s.term.resize(cols, rows)
}

window.killTerminal = function(sessionId, e) {
  e?.stopPropagation()
  if (window.ws?.readyState === WebSocket.OPEN) {
    window.ws.send(JSON.stringify({ type: 'pty_kill', sessionId }))
  }
  const s = termSessions.get(sessionId)
  if (s) {
    s.term.dispose()
    s.container.remove()
    s.tab.remove()
    termSessions.delete(sessionId)
  }
  // Activate another session if available
  const remaining = [...termSessions.keys()]
  if (remaining.length > 0) activateTerminal(remaining[remaining.length - 1])
  else { activeSessionId = null; document.getElementById('term-status').textContent = 'no session' }
}

// ── Handle PTY frames from WS ───────────────────────────────────────────
// Hook into the existing onmessage — wait for ws to be defined
function hookPtyFrames() {
  if (!window.ws) { setTimeout(hookPtyFrames, 200); return }

  const origOnMessage = window.ws.onmessage
  window.ws.onmessage = (event) => {
    // Let the existing handler run first
    if (origOnMessage) origOnMessage.call(window.ws, event)

    let f
    try { f = JSON.parse(event.data) } catch { return }

    switch (f.type) {
      case 'pty_spawned':
        createTerminalForSession(f.sessionId, f.agentId, f.cols, f.rows)
        // Switch to terminal view automatically
        window.switchView('terminal')
        break

      case 'pty_data': {
        const s = termSessions.get(f.sessionId)
        if (s) s.term.write(f.data)
        break
      }

      case 'pty_exit': {
        const s = termSessions.get(f.sessionId)
        if (s) {
          s.alive = false
          s.term.write(`\r\n\x1b[31m[process exited with code ${f.exitCode}]\x1b[0m\r\n`)
          document.getElementById(`dot-${f.sessionId}`)?.classList.add('dead')
          document.getElementById('term-status').textContent = `${s.agentId} exited (${f.exitCode})`
        }
        break
      }
    }
  }
}

// Re-hook whenever WS reconnects (the main script rebinds ws)
const _origConnect = window.connect
window.connect = function() {
  _origConnect?.()
  setTimeout(hookPtyFrames, 500)
}

// Also hook now if already connected
hookPtyFrames()

// Resize observer for terminal fitting
new ResizeObserver(() => {
  if (activeSessionId) fitTerm(activeSessionId)
}).observe(document.getElementById('terminal-containers'))
</script>
</body>
</html>
